define(["exports","three"],(function(e,t){"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){a=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw i}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function i(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function u(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var l,c,f,d,m,h,p,y,b,v,g,w,S,C,T,A,U,_,B,E,x,L,R,M=(l="undefined"!=typeof document&&document.currentScript?document.currentScript.src:void 0,function(e){var t;e=e||{},t||(t=void 0!==e?e:{});var n,r={};for(n in t)t.hasOwnProperty(n)&&(r[n]=t[n]);t.arguments=[],t.thisProgram="./this.program",t.quit=function(e,t){throw t},t.preRun=[],t.postRun=[];var a="";document.currentScript&&(a=document.currentScript.src),l&&(a=l),a=0!==a.indexOf("blob:")?a.substr(0,a.lastIndexOf("/")+1):"";var i=t.print||("undefined"!=typeof console?console.log.bind(console):"undefined"!=typeof print?print:null),s=t.printErr||("undefined"!=typeof printErr?printErr:"undefined"!=typeof console&&console.warn.bind(console)||i);for(n in r)r.hasOwnProperty(n)&&(t[n]=r[n]);function u(e){var t=T[F>>2];return(e=t+e+15&-16)>Ct()&&Xt(),T[F>>2]=e,t}r=void 0;var c,f={"f64-rem":function(e,t){return e%t},debugger:function(){}};"object"!==("undefined"==typeof WebAssembly?"undefined":o(WebAssembly))&&s("no native wasm support detected");var d,m=!1;function h(e,t){e||Xt("Assertion failed: "+t)}function p(e){var n=t["_"+e];return h(n,"Cannot call unknown function "+e+", make sure it is exported"),n}function y(e,t,n,r){var a={string:function(e){var t=0;if(null!=e&&0!==e){var n=1+(e.length<<2);t=kt(n),L(e,w,t,n)}return t},array:function(e){var t=kt(e.length);return g.set(e,t),t}},i=p(e),o=[];if(e=0,r)for(var s=0;s<r.length;s++){var u=a[n[s]];u?(0===e&&(e=Nt()),o[s]=u(r[s])):o[s]=r[s]}return n=function(e){return"string"===t?x(e):"boolean"===t?!!e:e}(n=i.apply(null,o)),0!==e&&Ot(e),n}function b(e){if("number"==typeof e)var t=!0,n=e;else t=!1,n=e.length;var r=It(Math.max(n,1));if(t){for(e=r,h(0==(3&r)),t=r+(-4&n);e<t;e+=4)T[e>>2]=0;for(t=r+n;e<t;)g[e++>>0]=0;return r}return e.subarray||e.slice?w.set(e,r):w.set(new Uint8Array(e),r),r}var v,g,w,S,C,T,A,U,_,B="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function E(e,t,n){var r=t+n;for(n=t;e[n]&&!(n>=r);)++n;if(16<n-t&&e.subarray&&B)return B.decode(e.subarray(t,n));for(r="";t<n;){var a=e[t++];if(128&a){var i=63&e[t++];if(192==(224&a))r+=String.fromCharCode((31&a)<<6|i);else{var o=63&e[t++];65536>(a=224==(240&a)?(15&a)<<12|i<<6|o:(7&a)<<18|i<<12|o<<6|63&e[t++])?r+=String.fromCharCode(a):(a-=65536,r+=String.fromCharCode(55296|a>>10,56320|1023&a))}}else r+=String.fromCharCode(a)}return r}function x(e){return e?E(w,e,void 0):""}function L(e,t,n,r){if(0<r){r=n+r-1;for(var a=0;a<e.length;++a){var i=e.charCodeAt(a);if(55296<=i&&57343>=i&&(i=65536+((1023&i)<<10)|1023&e.charCodeAt(++a)),127>=i){if(n>=r)break;t[n++]=i}else{if(2047>=i){if(n+1>=r)break;t[n++]=192|i>>6}else{if(65535>=i){if(n+2>=r)break;t[n++]=224|i>>12}else{if(n+3>=r)break;t[n++]=240|i>>18,t[n++]=128|i>>12&63}t[n++]=128|i>>6&63}t[n++]=128|63&i}}t[n]=0}}function R(e){for(var t=0,n=0;n<e.length;++n){var r=e.charCodeAt(n);55296<=r&&57343>=r&&(r=65536+((1023&r)<<10)|1023&e.charCodeAt(++n)),127>=r?++t:t=2047>=r?t+2:65535>=r?t+3:t+4}return t}function M(e){return 0<e%65536&&(e+=65536-e%65536),e}function P(){t.HEAP8=g=new Int8Array(v),t.HEAP16=S=new Int16Array(v),t.HEAP32=T=new Int32Array(v),t.HEAPU8=w=new Uint8Array(v),t.HEAPU16=C=new Uint16Array(v),t.HEAPU32=A=new Uint32Array(v),t.HEAPF32=U=new Float32Array(v),t.HEAPF64=_=new Float64Array(v)}"undefined"!=typeof TextDecoder&&new TextDecoder("utf-16le");var F=17008,G=t.TOTAL_MEMORY||134217728;function D(e){for(;0<e.length;){var n=e.shift();if("function"==typeof n)n();else{var r=n.Qb;"number"==typeof r?void 0===n.Nb?t.dynCall_v(r):t.dynCall_vi(r,n.Nb):r(void 0===n.Nb?null:n.Nb)}}}5242880>G&&s("TOTAL_MEMORY should be larger than TOTAL_STACK, was "+G+"! (TOTAL_STACK=5242880)"),(d=t.wasmMemory?t.wasmMemory:new WebAssembly.Memory({initial:G/65536}))&&(v=d.buffer),G=v.byteLength,P(),T[F>>2]=5259920;var I=[],z=[],k=[],O=[],N=[],W=!1;function j(){var e=t.preRun.shift();I.unshift(e)}var V=0,q=null,X=null;function H(){var e=Q;return String.prototype.startsWith?e.startsWith("data:application/octet-stream;base64,"):0===e.indexOf("data:application/octet-stream;base64,")}t.preloadedImages={},t.preloadedAudios={};var Q="umbra.wasm";if(!H()){var Y=Q;Q=t.locateFile?t.locateFile(Y,a):a+Y}function K(){try{if(t.wasmBinary)return new Uint8Array(t.wasmBinary);throw"both async and sync fetching of the wasm failed"}catch(e){Xt(e)}}function Z(e){function n(e){t.asm=e.exports,V--,t.monitorRunDependencies&&t.monitorRunDependencies(V),0==V&&(null!==q&&(clearInterval(q),q=null),X&&(e=X,X=null,e()))}function r(e){n(e.instance)}function a(e){return(t.wasmBinary||"function"!=typeof fetch?new Promise((function(e){e(K())})):fetch(Q,{credentials:"same-origin"}).then((function(e){if(!e.ok)throw"failed to load wasm binary file at '"+Q+"'";return e.arrayBuffer()})).catch((function(){return K()}))).then((function(e){return WebAssembly.instantiate(e,i)})).then(e,(function(e){s("failed to asynchronously prepare wasm: "+e),Xt(e)}))}var i={env:e,global:{NaN:NaN,Infinity:1/0},"global.Math":Math,asm2wasm:f};if(V++,t.monitorRunDependencies&&t.monitorRunDependencies(V),t.instantiateWasm)try{return t.instantiateWasm(i,n)}catch(e){return s("Module.instantiateWasm callback failed with error: "+e),!1}return function(){if(t.wasmBinary||"function"!=typeof WebAssembly.instantiateStreaming||H()||"function"!=typeof fetch)return a(r);fetch(Q,{credentials:"same-origin"}).then((function(e){return WebAssembly.instantiateStreaming(e,i).then(r,(function(e){s("wasm streaming compile failed: "+e),s("falling back to ArrayBuffer instantiation"),a(r)}))}))}(),{}}t.asm=function(e,t){return t.memory=d,t.table=new WebAssembly.Table({initial:358,maximum:358,element:"anyfunc"}),t.__memory_base=1024,t.__table_base=0,Z(t)};var J=[function(){alert("Invalid http method.")},function(e,n,r,a,i,o,s,u,l,c,f){return function(e,n,r,a,i,o,s,u,l,c,f){var d=x(e);n=x(n),o=x(o);var m=new XMLHttpRequest;m.open(n,d,!0),("GET"!=n||0!=o.length)&&(m.withCredentials=!0),m.responseType="arraybuffer";var h=function(){var e=St;return St++,e}();if(m.onload=function(){if(200==m.status){var n=new Uint8Array(m.response),o=t.URLsDownloaded;t.maxBytesDownloaded+=m.response.byteLength,o.has(e)||(o.add(e),t.minBytesDownloaded+=m.response.byteLength),c?n.length!=f?t.dynCall_viii(i,h,r,0):(w.set(n,c),t.dynCall_viiii(a,h,r,null,0)):(o=It(n.length),w.set(n,o),t.dynCall_viiii(a,h,r,o,n.length),Dt(o))}else t.dynCall_viii(i,h,r,m.status);delete wt[h]},m.onerror=function(){t.dynCall_viii(i,h,r,m.status),delete wt[h]},m.onabort=function(){delete wt[h]},0!=o.length&&m.setRequestHeader("Authorization","Basic "+btoa(o+":")),2<=(l=x(l).split("\n")).length)for(d=0;d<l.length;d+=2)m.setRequestHeader(l[d],l[d+1]);return"POST"==n?m.send(g.slice(s,s+u)):m.send(null),wt[h]=m,h}(e,n,r,a,i,o,s,u,l,c,f)},function(){alert("Uploads are not supported.")}];z.push({Qb:function(){zt()}});var $={};function ee(e,t){O.unshift({Qb:e,Nb:t})}var te=[null,[],[]];function ne(e,t){var n=te[e];0===t||10===t?((1===e?i:s)(E(n,0)),n.length=0):n.push(t)}var re=0;function ae(){return T[(re+=4)-4>>2]}var ie={},oe={};function se(e){for(;e.length;){var t=e.pop();e.pop()(t)}}function ue(e){return this.fromWireType(A[e>>2])}var le={},ce={},fe={};function de(e){if(void 0===e)return"_unknown";var t=(e=e.replace(/[^a-zA-Z0-9_]/g,"$")).charCodeAt(0);return 48<=t&&57>=t?"_"+e:e}function me(e,t){return e=de(e),new Function("body","return function "+e+'() {\n    "use strict";    return body.apply(this, arguments);\n};\n')(t)}function he(e){var t=Error,n=me(e,(function(t){this.name=e,this.message=t,void 0!==(t=Error(t).stack)&&(this.stack=this.toString()+"\n"+t.replace(/^Error(:[^\n]*)?\n/,""))}));return n.prototype=Object.create(t.prototype),n.prototype.constructor=n,n.prototype.toString=function(){return void 0===this.message?this.name:this.name+": "+this.message},n}var pe=void 0;function ye(e,t,n){function r(t){if((t=n(t)).length!==e.length)throw new pe("Mismatched type converter count");for(var r=0;r<e.length;++r)Ce(e[r],t[r])}e.forEach((function(e){fe[e]=t}));var a=Array(t.length),i=[],o=0;t.forEach((function(e,t){ce.hasOwnProperty(e)?a[t]=ce[e]:(i.push(e),le.hasOwnProperty(e)||(le[e]=[]),le[e].push((function(){a[t]=ce[e],++o===i.length&&r(a)})))})),0===i.length&&r(a)}function be(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+e)}}var ve=void 0;function ge(e){for(var t="";w[e];)t+=ve[w[e++]];return t}var we=void 0;function Se(e){throw new we(e)}function Ce(e,t,n){if(n=n||{},!("argPackAdvance"in t))throw new TypeError("registerType registeredInstance requires argPackAdvance");var r=t.name;if(e||Se('type "'+r+'" must have a positive integer typeid pointer'),ce.hasOwnProperty(e)){if(n.bc)return;Se("Cannot register type '"+r+"' twice")}ce[e]=t,delete fe[e],le.hasOwnProperty(e)&&(t=le[e],delete le[e],t.forEach((function(e){e()})))}var Te=[],Ae=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function Ue(e){4<e&&0==--Ae[e].Rb&&(Ae[e]=void 0,Te.push(e))}function _e(e){switch(e){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var t=Te.length?Te.pop():Ae.length;return Ae[t]={Rb:1,value:e},t}}function Be(e){if(null===e)return"null";var t=o(e);return"object"===t||"array"===t||"function"===t?e.toString():""+e}function Ee(e,t){switch(t){case 2:return function(e){return this.fromWireType(U[e>>2])};case 3:return function(e){return this.fromWireType(_[e>>3])};default:throw new TypeError("Unknown float type: "+e)}}function xe(e){var t=Function;if(!(t instanceof Function))throw new TypeError("new_ called with constructor type "+o(t)+" which is not a function");var n=me(t.name||"unknownFunctionName",(function(){}));return n.prototype=t.prototype,n=new n,(e=t.apply(n,e))instanceof Object?e:n}function Le(e,n,r){t.hasOwnProperty(e)?((void 0===r||void 0!==t[e].Lb&&void 0!==t[e].Lb[r])&&Se("Cannot register public name '"+e+"' twice"),function(e,n){var r=t;if(void 0===r[e].Lb){var a=r[e];r[e]=function(){return r[e].Lb.hasOwnProperty(arguments.length)||Se("Function '"+n+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+r[e].Lb+")!"),r[e].Lb[arguments.length].apply(this,arguments)},r[e].Lb=[],r[e].Lb[a.Vb]=a}}(e,e),t.hasOwnProperty(r)&&Se("Cannot register multiple overloads of a function with the same number of arguments ("+r+")!"),t[e].Lb[r]=n):(t[e]=n,void 0!==r&&(t[e].uc=r))}function Re(e,n){if(e=ge(e),void 0!==t["FUNCTION_TABLE_"+e])var r=t["FUNCTION_TABLE_"+e][n];else if("undefined"!=typeof FUNCTION_TABLE)r=FUNCTION_TABLE[n];else{void 0===(r=t["dynCall_"+e])&&void 0===(r=t["dynCall_"+e.replace(/f/g,"d")])&&Se("No dynCall invoker for signature: "+e);for(var a=[],i=1;i<e.length;++i)a.push("a"+i);i="return function dynCall_"+e+"_"+n+"("+a.join(", ")+") {\n",i+="    return dynCall(rawFunction"+(a.length?", ":"")+a.join(", ")+");\n",r=new Function("dynCall","rawFunction",i+"};\n")(r,n)}return"function"!=typeof r&&Se("unknown function pointer with signature "+e+": "+n),r}var Me=void 0;function Pe(e){var t=ge(e=Mt(e));return Dt(e),t}function Fe(e,t,n){switch(t){case 0:return n?function(e){return g[e]}:function(e){return w[e]};case 1:return n?function(e){return S[e>>1]}:function(e){return C[e>>1]};case 2:return n?function(e){return T[e>>2]}:function(e){return A[e>>2]};default:throw new TypeError("Unknown integer type: "+e)}}function Ge(e){return e||Se("Cannot use deleted val. handle = "+e),Ae[e].value}function De(e,t){var n=ce[e];return void 0===n&&Se(t+" has unknown type "+Pe(e)),n}var Ie={};function ze(e){var t=Ie[e];return void 0===t?ge(e):t}var ke=[];function Oe(){Xt()}var Ne,We,je,Ve=null,qe="",Xe=0,He=null,Qe=0,Ye=0,Ke=0,Ze=0,Je=[],$e={},et=!1,tt=!1,nt=[];function rt(){function e(){tt=document.pointerLockElement===t.canvas||document.mozPointerLockElement===t.canvas||document.webkitPointerLockElement===t.canvas||document.msPointerLockElement===t.canvas}if(t.preloadPlugins||(t.preloadPlugins=[]),!yt){yt=!0;try{bt=!0}catch(e){bt=!1,console.log("warning: no blob constructor, cannot create blobs with mimetypes")}vt="undefined"!=typeof MozBlobBuilder?MozBlobBuilder:"undefined"!=typeof WebKitBlobBuilder?WebKitBlobBuilder:bt?null:console.log("warning: no BlobBuilder"),gt="undefined"!=typeof window?window.URL?window.URL:window.webkitURL:void 0,t.Ub||void 0!==gt||(console.log("warning: Browser does not support creating object URLs. Built-in browser image decoding will not be available."),t.Ub=!0),t.preloadPlugins.push({canHandle:function(e){return!t.Ub&&/\.(jpg|jpeg|png|bmp)$/i.test(e)},handle:function(e,n,r,a){var i=null;if(bt)try{(i=new Blob([e],{type:dt(n)})).size!==e.length&&(i=new Blob([new Uint8Array(e).buffer],{type:dt(n)}))}catch(e){!function(e){c||(c={}),c[e]||(c[e]=1,s(e))}("Blob constructor present but fails: "+e+"; falling back to blob builder")}i||((i=new vt).append(new Uint8Array(e).buffer),i=i.getBlob());var o=gt.createObjectURL(i),u=new Image;u.onload=function(){h(u.complete,"Image "+n+" could not be decoded");var a=document.createElement("canvas");a.width=u.width,a.height=u.height,a.getContext("2d").drawImage(u,0,0),t.preloadedImages[n]=a,gt.revokeObjectURL(o),r&&r(e)},u.onerror=function(){console.log("Image "+o+" could not be decoded"),a&&a()},u.src=o}}),t.preloadPlugins.push({canHandle:function(e){return!t.tc&&e.substr(-4)in{".ogg":1,".wav":1,".mp3":1}},handle:function(e,n,r,a){function i(a){s||(s=!0,t.preloadedAudios[n]=a,r&&r(e))}function o(){s||(s=!0,t.preloadedAudios[n]=new Audio,a&&a())}var s=!1;if(!bt)return o();try{var u=new Blob([e],{type:dt(n)})}catch(e){return o()}u=gt.createObjectURL(u);var l=new Audio;l.addEventListener("canplaythrough",(function(){i(l)}),!1),l.onerror=function(){if(!s){console.log("warning: browser could not fully decode audio "+n+", trying slower base64 approach");for(var t="",r=0,a=0,o=0;o<e.length;o++)for(r=r<<8|e[o],a+=8;6<=a;){var u=r>>a-6&63;a-=6,t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[u]}2==a?(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(3&r)<<4],t+="=="):4==a&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(15&r)<<2],t+="="),l.src="data:audio/x-"+n.substr(-3)+";base64,"+t,i(l)}},l.src=u,function(e){t.noExitRuntime=!0,setTimeout((function(){m||e()}),1e4)}((function(){i(l)}))}});var n=t.canvas;n&&(n.requestPointerLock=n.requestPointerLock||n.mozRequestPointerLock||n.webkitRequestPointerLock||n.msRequestPointerLock||function(){},n.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock||document.msExitPointerLock||function(){},n.exitPointerLock=n.exitPointerLock.bind(document),document.addEventListener("pointerlockchange",e,!1),document.addEventListener("mozpointerlockchange",e,!1),document.addEventListener("webkitpointerlockchange",e,!1),document.addEventListener("mspointerlockchange",e,!1),t.elementPointerLock&&n.addEventListener("click",(function(e){!tt&&t.canvas.requestPointerLock&&(t.canvas.requestPointerLock(),e.preventDefault())}),!1))}}var at=!1,it=void 0,ot=void 0;function st(e,n,r){function a(){et=!1;var e=i.parentNode;(document.fullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitFullscreenElement||document.webkitCurrentFullScreenElement)===e?(i.exitFullscreen=lt,it&&i.requestPointerLock(),et=!0,ot?("undefined"!=typeof SDL&&(T[SDL.screen>>2]=8388608|A[SDL.screen>>2]),pt(t.canvas),ht()):pt(i)):(e.parentNode.insertBefore(i,e),e.parentNode.removeChild(e),ot?("undefined"!=typeof SDL&&(T[SDL.screen>>2]=-8388609&A[SDL.screen>>2]),pt(t.canvas),ht()):pt(i)),t.onFullScreen&&t.onFullScreen(et),t.onFullscreen&&t.onFullscreen(et)}void 0===(it=e)&&(it=!0),void 0===(ot=n)&&(ot=!1);var i=t.canvas;at||(at=!0,document.addEventListener("fullscreenchange",a,!1),document.addEventListener("mozfullscreenchange",a,!1),document.addEventListener("webkitfullscreenchange",a,!1),document.addEventListener("MSFullscreenChange",a,!1));var o=document.createElement("div");i.parentNode.insertBefore(o,i),o.appendChild(i),o.requestFullscreen=o.requestFullscreen||o.mozRequestFullScreen||o.msRequestFullscreen||(o.webkitRequestFullscreen?function(){o.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}:null)||(o.webkitRequestFullScreen?function(){o.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}:null),r?o.requestFullscreen({wc:r}):o.requestFullscreen()}function ut(e,t,n){s("Browser.requestFullScreen() is deprecated. Please call Browser.requestFullscreen instead."),ut=function(e,t,n){st(e,t,n)},st(e,t,n)}function lt(){return!!et&&((document.exitFullscreen||document.cancelFullScreen||document.mozCancelFullScreen||document.msExitFullscreen||document.webkitCancelFullScreen||function(){}).apply(document,[]),!0)}var ct=0;function ft(e){if("function"==typeof requestAnimationFrame)requestAnimationFrame(e);else{var t=Date.now();if(0===ct)ct=t+1e3/60;else for(;t+2>=ct;)ct+=1e3/60;setTimeout(e,Math.max(ct-t,0))}}function dt(e){return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",bmp:"image/bmp",ogg:"audio/ogg",wav:"audio/wav",mp3:"audio/mpeg"}[e.substr(e.lastIndexOf(".")+1)]}var mt=[];function ht(){var e=t.canvas;mt.forEach((function(t){t(e.width,e.height)}))}function pt(e,n,r){n&&r?(e.jc=n,e.ac=r):(n=e.jc,r=e.ac);var a=n,i=r;if(t.forcedAspectRatio&&0<t.forcedAspectRatio&&(a/i<t.forcedAspectRatio?a=Math.round(i*t.forcedAspectRatio):i=Math.round(a/t.forcedAspectRatio)),(document.fullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitFullscreenElement||document.webkitCurrentFullScreenElement)===e.parentNode&&"undefined"!=typeof screen){var o=Math.min(screen.width/a,screen.height/i);a=Math.round(a*o),i=Math.round(i*o)}ot?(e.width!=a&&(e.width=a),e.height!=i&&(e.height=i),void 0!==e.style&&(e.style.removeProperty("width"),e.style.removeProperty("height"))):(e.width!=n&&(e.width=n),e.height!=r&&(e.height=r),void 0!==e.style&&(a!=n||i!=r?(e.style.setProperty("width",a+"px","important"),e.style.setProperty("height",i+"px","important")):(e.style.removeProperty("width"),e.style.removeProperty("height"))))}var yt,bt,vt,gt,wt={},St=0;function Ct(){return g.length}var Tt,At={};function Ut(e,t){var n=At[e];if(n)t(null,n);else{try{var r=function(){if("undefined"!=typeof indexedDB)return indexedDB;var e=null;return"object"===("undefined"==typeof window?"undefined":o(window))&&(e=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB),h(e,"IDBStore used, but indexedDB not supported"),e}().open(e,22)}catch(e){return void t(e)}r.onupgradeneeded=function(e){var t=e.target.result;e=e.target.transaction,t.objectStoreNames.contains("FILE_DATA")?e.objectStore("FILE_DATA"):t.createObjectStore("FILE_DATA")},r.onsuccess=function(){n=r.result,At[e]=n,t(null,n)},r.onerror=function(e){t(this.error),e.preventDefault()}}}function _t(e,t,n){Ut(e,(function(e,r){if(e)return n(e);(e=r.transaction(["FILE_DATA"],t)).onerror=function(e){n(this.error||"unknown error"),e.preventDefault()},e=e.objectStore("FILE_DATA"),n(null,e)}))}function Bt(e){!t.noExitRuntime&&(m=!0,D(O),t.onExit)&&t.onExit(e),t.quit(e,new Vt(e))}t._exit=Bt,L("GMT",w,16912,4),O.push((function(){var e=t._fflush;e&&e(0),te[1].length&&ne(1,10),te[2].length&&ne(2,10)})),pe=t.InternalError=he("InternalError");for(var Et=Array(256),xt=0;256>xt;++xt)Et[xt]=String.fromCharCode(xt);function Lt(e){var t=Array(R(e)+1);return L(e,t,0,t.length),t}ve=Et,we=t.BindingError=he("BindingError"),t.count_emval_handles=function(){for(var e=0,t=5;t<Ae.length;++t)void 0!==Ae[t]&&++e;return e},t.get_first_emval=function(){for(var e=5;e<Ae.length;++e)if(void 0!==Ae[e])return Ae[e];return null},Me=t.UnboundTypeError=he("UnboundTypeError"),t.requestFullScreen=function(e,n,r){s("Module.requestFullScreen is deprecated. Please call Module.requestFullscreen instead."),t.requestFullScreen=t.requestFullscreen,ut(e,n,r)},t.requestFullscreen=function(e,t,n){st(e,t,n)},t.requestAnimationFrame=function(e){ft(e)},t.setCanvasSize=function(e,n,r){pt(t.canvas,e,n),r||ht()},t.pauseMainLoop=function(){Ve=null,Xe++},t.resumeMainLoop=function(){Xe++;var e=Ye,n=Ke,r=He;He=null,function(e){var n=Qe;t.noExitRuntime=!0,h(!He,"emscripten_set_main_loop: there can only be one main loop function at once: call emscripten_cancel_main_loop to cancel the previous one before setting a new one with different parameters."),He=e,Qe=n;var r=void 0!==n?function(){t.dynCall_vi(e,n)}:function(){t.dynCall_v(e)},a=Xe;We=function(){if(!m)if(0<Je.length){var e=Date.now(),n=Je.shift();if(n.Qb(n.Nb),je){var i=je,u=0==i%1?i-1:Math.floor(i);je=n.lc?u:(8*i+(u+.5))/9}console.log('main loop blocker "'+n.name+'" took '+(Date.now()-e)+" ms"),t.setStatus&&(e=t.statusMessage||"Please wait...",n=je,i=$e.pc,n?n<i?t.setStatus(e+" ("+(i-n)+"/"+i+")"):t.setStatus(e):t.setStatus("")),a<Xe||setTimeout(We,0)}else if(!(a<Xe))if(Ze=Ze+1|0,1==Ye&&1<Ke&&0!=Ze%Ke)Ve();else{0==Ye&&(Ne=Oe()),"timeout"===qe&&t.Pb&&(s("Looks like you are rendering without using requestAnimationFrame for the main loop. You should use 0 for the frame rate in emscripten_set_main_loop in order to use requestAnimationFrame, as that can greatly improve your frame rates!"),qe="");e:if(!(m||t.preMainLoop&&!1===t.preMainLoop())){try{r()}catch(e){if(e instanceof Vt)break e;throw e&&"object"===o(e)&&e.stack&&s("exception thrown: "+[e,e.stack]),e}t.postMainLoop&&t.postMainLoop()}a<Xe||("object"===("undefined"==typeof SDL?"undefined":o(SDL))&&SDL.audio&&SDL.audio.dc&&SDL.audio.dc(),Ve())}}}(r),function(e,t){if(Ye=e,Ke=t,He)if(0==e)Ve=function(){var e=0|Math.max(0,Ne+t-Oe());setTimeout(We,e)},qe="timeout";else if(1==e)Ve=function(){ft(We)},qe="rAF";else if(2==e){if("undefined"==typeof setImmediate){var n=[];addEventListener("message",(function(e){"setimmediate"!==e.data&&"setimmediate"!==e.data.target||(e.stopPropagation(),n.shift()())}),!0),setImmediate=function(e){n.push(e),postMessage("setimmediate","*")}}Ve=function(){setImmediate(We)},qe="immediate"}}(e,n),Ve()},t.getUserMedia=function(){window.getUserMedia||(window.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia),window.getUserMedia(void 0)},t.createContext=function(e,n,r,a){return function(e,n,r,a){if(n&&t.Pb&&e==t.canvas)return t.Pb;var i;if(n){var o={antialias:!1,alpha:!1,rc:1};if(a)for(var s in a)o[s]=a[s];if("undefined"!=typeof GL&&(i=GL.mc(e,o)))var u=GL.getContext(i).kc}else u=e.getContext("2d");return u?(r&&(n||h("undefined"==typeof GLctx,"cannot set in module if GLctx is used, but we are a non-GL context that would replace it"),t.Pb=u,n&&GL.sc(i),t.vc=n,nt.forEach((function(e){e()})),rt()),u):null}(e,n,r,a)},Oe="undefined"!=typeof dateNow?dateNow:"object"===("undefined"==typeof performance?"undefined":o(performance))&&performance&&"function"==typeof performance.now?function(){return performance.now()}:Date.now;var Rt=t.asm({},{j:Xt,y:function(){},fa:function(){s("missing function: _ZN5Umbra13MiniSceneCopy7connectERK20UmbraSceneCopySource"),Xt(-1)},ba:function(){s("missing function: _ZN5Umbra13MiniSceneCopy9getStatusEPf"),Xt(-1)},C:function(){s("missing function: _ZN5Umbra13MiniSceneCopyC1ERNS_11MiniRuntimeERK25UmbraSceneCopyDestinationPK20UmbraEnvironmentInfoRKN5Eigen6MatrixIfLi3ELi1ELi0ELi3ELi1EEEfi"),Xt(-1)},Z:function e(n){if(e.Wb)var r=T[n>>2],a=T[r>>2];else e.Wb=!0,$.USER=$.LOGNAME="web_user",$.PATH="/",$.PWD="/",$.HOME="/home/web_user",$.LANG="C.UTF-8",$.LANG=("object"===("undefined"==typeof navigator?"undefined":o(navigator))&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",$._=t.thisProgram,a=W?It(1024):u(1024),r=W?It(256):u(256),T[r>>2]=a,T[n>>2]=r;n=[];var i,s=0;for(i in $)if("string"==typeof $[i]){var l=i+"="+$[i];n.push(l),s+=l.length}if(1024<s)throw Error("Environment size exceeded TOTAL_ENV_SIZE!");for(i=0;i<n.length;i++){s=l=n[i];for(var c=a,f=0;f<s.length;++f)g[c++>>0]=s.charCodeAt(f);g[c>>0]=0,T[r+4*i>>2]=a,a+=l.length+1}T[r+4*n.length>>2]=0},U:function(){return ee.apply(null,arguments)},v:function(){},x:function(e){return t.___errno_location&&(T[t.___errno_location()>>2]=e),e},M:function(e,t){re=t;try{return ie.Tb(),ae(),ae(),ae(),ae(),0}catch(e){return Xt(e),-e.Ob}},L:function(e,t){re=t;try{var n=ie.Tb(),r=ae(),a=ae();return ie.nc(n,r,a)}catch(e){return Xt(e),-e.Ob}},K:function(e,t){re=t;try{var n=ae(),r=ae(),a=ae();for(t=e=0;t<a;t++){for(var i=T[r+8*t>>2],o=T[r+(8*t+4)>>2],s=0;s<o;s++)ne(n,w[i+s]);e+=o}return e}catch(e){return Xt(e),-e.Ob}},ea:function(e,t){re=t;try{var n=x(ae()),r=ae();return ie.oc((void 0).stat,n,r)}catch(e){return Xt(e),-e.Ob}},J:function(e,t){return re=t,0},da:function(e,t){re=t;try{var n=x(ae()),r=ae(),a=ae();return(void 0).open(n,r,a).qc}catch(e){return Xt(e),-e.Ob}},I:function(e,t){return re=t,0},H:function(e,t){re=t;try{return ie.Tb(),0}catch(e){return Xt(e),-e.Ob}},w:function(){},G:function(e){var t=oe[e];delete oe[e];var n=t.ec,r=t.fc,a=t.Sb;ye([e],a.map((function(e){return e.$b})).concat(a.map((function(e){return e.hc}))),(function(e){var i={};return a.forEach((function(t,n){var r=e[n],o=t.Yb,s=t.Zb,u=e[n+a.length],l=t.gc,c=t.ic;i[t.Xb]={read:function(e){return r.fromWireType(o(s,e))},write:function(e,t){var n=[];l(c,e,u.toWireType(n,t)),se(n)}}})),[{name:t.name,fromWireType:function(e){var t,n={};for(t in i)n[t]=i[t].read(e);return r(e),n},toWireType:function(e,t){for(var a in i)if(!(a in t))throw new TypeError("Missing field");var o=n();for(a in i)i[a].write(o,t[a]);return null!==e&&e.push(r,o),o},argPackAdvance:8,readValueFromPointer:ue,Mb:r}]}))},ca:function(e,t,n,r,a){var i=be(n);Ce(e,{name:t=ge(t),fromWireType:function(e){return!!e},toWireType:function(e,t){return t?r:a},argPackAdvance:8,readValueFromPointer:function(e){if(1===n)var r=g;else if(2===n)r=S;else{if(4!==n)throw new TypeError("Unknown boolean type size: "+t);r=T}return this.fromWireType(r[e>>i])},Mb:null})},p:function(e,n,r){e=ge(e),ye([],[n],(function(n){return n=n[0],t[e]=n.fromWireType(r),[]}))},aa:function(e,t){Ce(e,{name:t=ge(t),fromWireType:function(e){var t=Ae[e].value;return Ue(e),t},toWireType:function(e,t){return _e(t)},argPackAdvance:8,readValueFromPointer:ue,Mb:null})},F:function(e,t,n){n=be(n),Ce(e,{name:t=ge(t),fromWireType:function(e){return e},toWireType:function(e,t){if("number"!=typeof t&&"boolean"!=typeof t)throw new TypeError('Cannot convert "'+Be(t)+'" to '+this.name);return t},argPackAdvance:8,readValueFromPointer:Ee(t,n),Mb:null})},k:function(e,n,r,a,i,o){var s=function(e,t){for(var n=[],r=0;r<e;r++)n.push(T[(t>>2)+r]);return n}(n,r);e=ge(e),i=Re(a,i),Le(e,(function(){!function(e,t){var n=[],r={};throw t.forEach((function e(t){r[t]||ce[t]||(fe[t]?fe[t].forEach(e):(n.push(t),r[t]=!0))})),new Me(e+": "+n.map(Pe).join([", "]))}("Cannot call "+e+" due to unbound types",s)}),n-1),ye([],s,(function(r){var a=e,s=e;r=[r[0],null].concat(r.slice(1));var u=i,l=r.length;2>l&&Se("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var c=null!==r[1]&&!1,f=!1,d=1;d<r.length;++d)if(null!==r[d]&&void 0===r[d].Mb){f=!0;break}var m="void"!==r[0].name,h="",p="";for(d=0;d<l-2;++d)h+=(0!==d?", ":"")+"arg"+d,p+=(0!==d?", ":"")+"arg"+d+"Wired";s="return function "+de(s)+"("+h+") {\nif (arguments.length !== "+(l-2)+") {\nthrowBindingError('function "+s+" called with ' + arguments.length + ' arguments, expected "+(l-2)+" args!');\n}\n",f&&(s+="var destructors = [];\n");var y=f?"destructors":"null";for(h="throwBindingError invoker fn runDestructors retType classParam".split(" "),u=[Se,u,o,se,r[0],r[1]],c&&(s+="var thisWired = classParam.toWireType("+y+", this);\n"),d=0;d<l-2;++d)s+="var arg"+d+"Wired = argType"+d+".toWireType("+y+", arg"+d+"); // "+r[d+2].name+"\n",h.push("argType"+d),u.push(r[d+2]);if(c&&(p="thisWired"+(0<p.length?", ":"")+p),s+=(m?"var rv = ":"")+"invoker(fn"+(0<p.length?", ":"")+p+");\n",f)s+="runDestructors(destructors);\n";else for(d=c?1:2;d<r.length;++d)l=1===d?"thisWired":"arg"+(d-2)+"Wired",null!==r[d].Mb&&(s+=l+"_dtor("+l+"); // "+r[d].name+"\n",h.push(l+"_dtor"),u.push(r[d].Mb));if(m&&(s+="var ret = retType.fromWireType(rv);\nreturn ret;\n"),h.push(s+"}\n"),r=xe(h).apply(null,u),d=n-1,!t.hasOwnProperty(a))throw new pe("Replacing nonexistant public symbol");return void 0!==t[a].Lb&&void 0!==d?t[a].Lb[d]=r:(t[a]=r,t[a].Vb=d),[]}))},s:function(e,t,n,r,a){function i(e){return e}t=ge(t),-1===a&&(a=4294967295);var o=be(n);if(0===r){var s=32-8*n;i=function(e){return e<<s>>>s}}var u=-1!=t.indexOf("unsigned");Ce(e,{name:t,fromWireType:i,toWireType:function(e,n){if("number"!=typeof n&&"boolean"!=typeof n)throw new TypeError('Cannot convert "'+Be(n)+'" to '+this.name);if(n<r||n>a)throw new TypeError('Passing a number "'+Be(n)+'" from JS side to C/C++ side to an argument of type "'+t+'", which is outside the valid range ['+r+", "+a+"]!");return u?n>>>0:0|n},argPackAdvance:8,readValueFromPointer:Fe(t,o,0!==r),Mb:null})},o:function(e,t,n){function r(e){e>>=2;var t=A;return new a(t.buffer,t[e+1],t[e])}var a=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t];Ce(e,{name:n=ge(n),fromWireType:r,argPackAdvance:8,readValueFromPointer:r},{bc:!0})},E:function(e,t){var n="std::string"===(t=ge(t));Ce(e,{name:t,fromWireType:function(e){var t=A[e>>2];if(n){var r=w[e+4+t],a=0;0!=r&&(a=r,w[e+4+t]=0);var i=e+4;for(r=0;r<=t;++r){var o=e+4+r;if(0==w[o]){if(i=x(i),void 0===s)var s=i;else s+=String.fromCharCode(0),s+=i;i=o+1}}0!=a&&(w[e+4+t]=a)}else{for(s=Array(t),r=0;r<t;++r)s[r]=String.fromCharCode(w[e+4+r]);s=s.join("")}return Dt(e),s},toWireType:function(e,t){t instanceof ArrayBuffer&&(t=new Uint8Array(t));var r="string"==typeof t;r||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int8Array||Se("Cannot pass non-string to std::string");var a=(n&&r?function(){return R(t)}:function(){return t.length})(),i=It(4+a+1);if(A[i>>2]=a,n&&r)L(t,w,i+4,a+1);else if(r)for(r=0;r<a;++r){var o=t.charCodeAt(r);255<o&&(Dt(i),Se("String has UTF-16 code units that do not fit in 8 bits")),w[i+4+r]=o}else for(r=0;r<a;++r)w[i+4+r]=t[r];return null!==e&&e.push(Dt,i),i},argPackAdvance:8,readValueFromPointer:ue,Mb:function(e){Dt(e)}})},$:function(e,t,n){if(n=ge(n),2===t)var r=function(){return C},a=1;else 4===t&&(r=function(){return A},a=2);Ce(e,{name:n,fromWireType:function(e){for(var t=r(),n=A[e>>2],i=Array(n),o=e+4>>a,s=0;s<n;++s)i[s]=String.fromCharCode(t[o+s]);return Dt(e),i.join("")},toWireType:function(e,n){var i=r(),o=n.length,s=It(4+o*t);A[s>>2]=o;for(var u=s+4>>a,l=0;l<o;++l)i[u+l]=n.charCodeAt(l);return null!==e&&e.push(Dt,s),s},argPackAdvance:8,readValueFromPointer:ue,Mb:function(e){Dt(e)}})},D:function(e,t,n,r,a,i){oe[e]={name:ge(t),ec:Re(n,r),fc:Re(a,i),Sb:[]}},t:function(e,t,n,r,a,i,o,s,u,l){oe[e].Sb.push({Xb:ge(t),$b:n,Yb:Re(r,a),Zb:i,hc:o,gc:Re(s,u),ic:l})},_:function(e,t){Ce(e,{cc:!0,name:t=ge(t),argPackAdvance:0,fromWireType:function(){},toWireType:function(){}})},i:function(e,t,n){e=Ge(e),t=De(t,"emval::as");var r=[],a=_e(r);return T[n>>2]=a,t.toWireType(r,e)},m:function(e,t,n,r){(e=ke[e])(t=Ge(t),n=ze(n),null,r)},c:Ue,l:function(e,t){for(var n=(t=function(e,t){for(var n=Array(e),r=0;r<e;++r)n[r]=De(T[(t>>2)+r],"parameter "+r);return n}(e,t))[0],r=n.name+"_$"+t.slice(1).map((function(e){return e.name})).join("_")+"$",a=["retType"],i=[n],o="",s=0;s<e-1;++s)o+=(0!==s?", ":"")+"arg"+s,a.push("argType"+s),i.push(t[1+s]);r="return function "+de("methodCaller_"+r)+"(handle, name, destructors, args) {\n";var u=0;for(s=0;s<e-1;++s)r+="    var arg"+s+" = argType"+s+".readValueFromPointer(args"+(u?"+"+u:"")+");\n",u+=t[s+1].argPackAdvance;for(r+="    var rv = handle[name]("+o+");\n",s=0;s<e-1;++s)t[s+1].deleteObject&&(r+="    argType"+s+".deleteObject(arg"+s+");\n");return n.cc||(r+="    return retType.toWireType(destructors, rv);\n"),a.push(r+"};\n"),function(e){var t=ke.length;return ke.push(e),t}(e=xe(a).apply(null,i))},g:function(e,t){return _e((e=Ge(e))[t=Ge(t)])},u:function(e){4<e&&(Ae[e].Rb+=1)},r:function(){return _e([])},e:function(e){return _e(ze(e))},q:function(){return _e({})},h:function(e){se(Ae[e].value),Ue(e)},f:function(e,t,n){e=Ge(e),t=Ge(t),n=Ge(n),e[t]=n},d:function(e,t){return _e(e=(e=De(e,"_emval_take_value")).readValueFromPointer(t))},Y:function(){t.abort()},B:function(e){return J[e]()},X:function(e,t,n,r,a,i,o,s,u,l,c,f){return J[e](t,n,r,a,i,o,s,u,l,c,f)},A:function(e){(e=wt[e])&&e.abort()},W:Ct,n:Oe,z:function(e,t,n,r,a){!function(e,t,n){_t(e,"readonly",(function(e,r){if(e)return n(e);(e=r.get(t)).onsuccess=function(e){return(e=e.target.result)?n(null,e):n("file "+t+" not found")},e.onerror=function(e){n(e)}}))}(x(e),x(t),(function(e,t){e?a&&Wt(a,n):(e=It(t.length),w.set(t,e),jt(r,n,e,t.length),Dt(e))}))},V:function(e,t,n,r,a,i,o){!function(e,t,n,r){_t(e,"readwrite",(function(e,a){if(e)return r(e);(e=a.put(n,t)).onsuccess=function(){r()},e.onerror=function(e){r(e)}}))}(x(e),x(t),new Uint8Array(w.subarray(n,n+r)),(function(e){e?o&&Wt(o,a):i&&Wt(i,a)}))},T:function(e,t,n){w.set(w.subarray(t,t+n),e)},S:function(e){if(2147418112<e)return!1;for(var t=Math.max(Ct(),16777216);t<e;)t=536870912>=t?M(2*t):Math.min(M((3*t+2147483648)/4),2147418112);return!!function(e){e=M(e);var t=v.byteLength;try{return-1!==d.grow((e-t)/65536)&&(v=d.buffer,!0)}catch(e){return!1}}(t)&&(P(),!0)},R:Bt,Q:function(){Xt("trap!")},P:function(e){!function(){function e(e){return(e=e.toTimeString().match(/\(([A-Za-z ]+)\)$/))?e[1]:"GMT"}if(!Tt){Tt=!0,T[Ft()>>2]=60*(new Date).getTimezoneOffset();var t=new Date(2e3,0,1),n=new Date(2e3,6,1);T[Pt()>>2]=Number(t.getTimezoneOffset()!=n.getTimezoneOffset());var r=e(t),a=e(n);r=b(Lt(r)),a=b(Lt(a)),n.getTimezoneOffset()<t.getTimezoneOffset()?(T[Gt()>>2]=r,T[Gt()+4>>2]=a):(T[Gt()>>2]=a,T[Gt()+4>>2]=r)}}(),e=new Date(1e3*T[e>>2]),T[4216]=e.getSeconds(),T[4217]=e.getMinutes(),T[4218]=e.getHours(),T[4219]=e.getDate(),T[4220]=e.getMonth(),T[4221]=e.getFullYear()-1900,T[4222]=e.getDay();var t=new Date(e.getFullYear(),0,1);T[4223]=(e.getTime()-t.getTime())/864e5|0,T[4225]=-60*e.getTimezoneOffset();var n=new Date(2e3,6,1).getTimezoneOffset();return e=0|(n!=(t=t.getTimezoneOffset())&&e.getTimezoneOffset()==Math.min(t,n)),T[4224]=e,e=T[Gt()+(e?4:0)>>2],T[4226]=e,16864},O:function(e){var t=Date.now()/1e3|0;return e&&(T[e>>2]=t),t},N:function(){Xt("OOM")},a:F,b:16848},v);t.asm=Rt,t._UmbraAssetLoadAbortRequested=function(){return t.asm.ga.apply(null,arguments)},t._UmbraAssetLoadFinish=function(){return t.asm.ha.apply(null,arguments)},t._UmbraAssetLoadGetType=function(){return t.asm.ia.apply(null,arguments)},t._UmbraAssetLoadPrepare=function(){return t.asm.ja.apply(null,arguments)},t._UmbraAssetUnloadFinish=function(){return t.asm.ka.apply(null,arguments)},t._UmbraAssetUnloadGetType=function(){return t.asm.la.apply(null,arguments)},t._UmbraAssetUnloadGetUserPointer=function(){return t.asm.ma.apply(null,arguments)},t._UmbraClientCreate=function(){return t.asm.na.apply(null,arguments)},t._UmbraClientDestroy=function(){return t.asm.oa.apply(null,arguments)},t._UmbraConfigInit=function(){return t.asm.pa.apply(null,arguments)},t._UmbraEcefToGeodetic=function(){return t.asm.qa.apply(null,arguments)},t._UmbraEnvironmentInfoDefaults=function(){return t.asm.ra.apply(null,arguments)},t._UmbraGeodeticToEcef=function(){return t.asm.sa.apply(null,arguments)},t._UmbraGetLibraryInfo=function(){return t.asm.ta.apply(null,arguments)},t._UmbraMaterialLoadGetInfo=function(){return t.asm.ua.apply(null,arguments)},t._UmbraMeshLoadGetData=function(){return t.asm.va.apply(null,arguments)},t._UmbraMeshLoadGetInfo=function(){return t.asm.wa.apply(null,arguments)},t._UmbraMeshStreamDone=function(){return t.asm.xa.apply(null,arguments)},t._UmbraMeshStreamNext=function(){return t.asm.ya.apply(null,arguments)},t._UmbraMeshStreamSetBuffers=function(){return t.asm.za.apply(null,arguments)},t._UmbraRuntimeCreate=function(){return t.asm.Aa.apply(null,arguments)},t._UmbraRuntimeDestroy=function(){return t.asm.Ba.apply(null,arguments)},t._UmbraRuntimeGetStreamingState=function(){return t.asm.Ca.apply(null,arguments)},t._UmbraRuntimeNextAssetLoad=function(){return t.asm.Da.apply(null,arguments)},t._UmbraRuntimeNextAssetUnload=function(){return t.asm.Ea.apply(null,arguments)},t._UmbraRuntimeUpdate=function(){return t.asm.Fa.apply(null,arguments)},t._UmbraSceneCopyCreate=function(){return t.asm.Ga.apply(null,arguments)},t._UmbraSceneCopyDestroy=function(){return t.asm.Ha.apply(null,arguments)},t._UmbraSceneCopyGetError=function(){return t.asm.Ia.apply(null,arguments)},t._UmbraSceneCopyGetStatus=function(){return t.asm.Ja.apply(null,arguments)},t._UmbraSceneCreate=function(){return t.asm.Ka.apply(null,arguments)},t._UmbraSceneCreateLocal=function(){return t.asm.La.apply(null,arguments)},t._UmbraSceneCreatePublic=function(){return t.asm.Ma.apply(null,arguments)},t._UmbraSceneDestroy=function(){return t.asm.Na.apply(null,arguments)},t._UmbraSceneGetConnectionStatus=function(){return t.asm.Oa.apply(null,arguments)},t._UmbraSceneGetInfo=function(){return t.asm.Pa.apply(null,arguments)},t._UmbraSceneSetTransform=function(){return t.asm.Qa.apply(null,arguments)},t._UmbraSetAllocator=function(){return t.asm.Ra.apply(null,arguments)},t._UmbraSetHttp=function(){return t.asm.Sa.apply(null,arguments)},t._UmbraSetLogger=function(){return t.asm.Ta.apply(null,arguments)},t._UmbraTextureGetMipmapLevelByteSize=function(){return t.asm.Ua.apply(null,arguments)},t._UmbraTextureGetMipmapLevelOffset=function(){return t.asm.Va.apply(null,arguments)},t._UmbraTextureLoadGetData=function(){return t.asm.Wa.apply(null,arguments)},t._UmbraTextureLoadGetInfo=function(){return t.asm.Xa.apply(null,arguments)},t._UmbraTextureMetaDataGetClassification=function(){return t.asm.Ya.apply(null,arguments)},t._UmbraTextureMetaDataGetClassificationAmount=function(){return t.asm.Za.apply(null,arguments)},t._UmbraTextureMetaDataGetClassificationCount=function(){return t.asm._a.apply(null,arguments)},t._UmbraTextureMetaDataLoadGetData=function(){return t.asm.$a.apply(null,arguments)},t._UmbraVertexAttributeGetElementByteSize=function(){return t.asm.ab.apply(null,arguments)},t._UmbraViewCreate=function(){return t.asm.bb.apply(null,arguments)},t._UmbraViewDestroy=function(){return t.asm.cb.apply(null,arguments)},t._UmbraViewGetCompleted=function(){return t.asm.db.apply(null,arguments)},t._UmbraViewNextRenderables=function(){return t.asm.eb.apply(null,arguments)},t._UmbraViewResetRenderables=function(){return t.asm.fb.apply(null,arguments)},t._UmbraViewUpdateFilter=function(){return t.asm.gb.apply(null,arguments)},t._UmbraViewUpdateRendering=function(){return t.asm.hb.apply(null,arguments)},t.___embind_register_native_and_builtin_types=function(){return t.asm.ib.apply(null,arguments)};var Mt=t.___getTypeName=function(){return t.asm.jb.apply(null,arguments)},Pt=t.__get_daylight=function(){return t.asm.kb.apply(null,arguments)},Ft=t.__get_timezone=function(){return t.asm.lb.apply(null,arguments)},Gt=t.__get_tzname=function(){return t.asm.mb.apply(null,arguments)},Dt=t._free=function(){return t.asm.nb.apply(null,arguments)},It=t._malloc=function(){return t.asm.ob.apply(null,arguments)},zt=t.globalCtors=function(){return t.asm.Hb.apply(null,arguments)},kt=t.stackAlloc=function(){return t.asm.Ib.apply(null,arguments)},Ot=t.stackRestore=function(){return t.asm.Jb.apply(null,arguments)},Nt=t.stackSave=function(){return t.asm.Kb.apply(null,arguments)};t.dynCall_i=function(){return t.asm.pb.apply(null,arguments)},t.dynCall_ii=function(){return t.asm.qb.apply(null,arguments)},t.dynCall_iii=function(){return t.asm.rb.apply(null,arguments)},t.dynCall_iiii=function(){return t.asm.sb.apply(null,arguments)},t.dynCall_iiiii=function(){return t.asm.tb.apply(null,arguments)},t.dynCall_iiiiii=function(){return t.asm.ub.apply(null,arguments)},t.dynCall_iiiiiii=function(){return t.asm.vb.apply(null,arguments)},t.dynCall_iiiiiiiiii=function(){return t.asm.wb.apply(null,arguments)},t.dynCall_iiiji=function(){return t.asm.xb.apply(null,arguments)},t.dynCall_jiji=function(){return t.asm.yb.apply(null,arguments)},t.dynCall_v=function(){return t.asm.zb.apply(null,arguments)};var Wt=t.dynCall_vi=function(){return t.asm.Ab.apply(null,arguments)};t.dynCall_vii=function(){return t.asm.Bb.apply(null,arguments)};var jt=t.dynCall_viii=function(){return t.asm.Cb.apply(null,arguments)};function Vt(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e}function qt(){function e(){if(!t.calledRun&&(t.calledRun=!0,!m)){if(W=!0,D(z),D(k),t.onRuntimeInitialized&&t.onRuntimeInitialized(),t.postRun)for("function"==typeof t.postRun&&(t.postRun=[t.postRun]);t.postRun.length;){var e=t.postRun.shift();N.unshift(e)}D(N)}}if(!(0<V)){if(t.preRun)for("function"==typeof t.preRun&&(t.preRun=[t.preRun]);t.preRun.length;)j();D(I),0<V||t.calledRun||(t.setStatus?(t.setStatus("Running..."),setTimeout((function(){setTimeout((function(){t.setStatus("")}),1),e()}),1)):e())}}function Xt(e){throw t.onAbort&&t.onAbort(e),i(e),s(e),m=!0,"abort("+e+"). Build with -s ASSERTIONS=1 for more info."}if(t.dynCall_viiii=function(){return t.asm.Db.apply(null,arguments)},t.dynCall_viiiii=function(){return t.asm.Eb.apply(null,arguments)},t.dynCall_viiiiii=function(){return t.asm.Fb.apply(null,arguments)},t.dynCall_viiiiiiiii=function(){return t.asm.Gb.apply(null,arguments)},t.asm=Rt,t.cwrap=function(e,t,n,r){var a=(n=n||[]).every((function(e){return"number"===e}));return"string"!==t&&a&&!r?p(e):function(){return y(e,t,n,arguments)}},t.then=function(e){if(t.calledRun)e(t);else{var n=t.onRuntimeInitialized;t.onRuntimeInitialized=function(){n&&n(),e(t)}}return t},Vt.prototype=Error(),Vt.prototype.constructor=Vt,X=function e(){t.calledRun||qt(),t.calledRun||(X=e)},t.run=qt,t.abort=Xt,t.preInit)for("function"==typeof t.preInit&&(t.preInit=[t.preInit]);0<t.preInit.length;)t.preInit.pop()();return qt(),t.maxBytesDownloaded=0,t.minBytesDownloaded=0,t.URLsDownloaded=new Set([]),t.wgetRequests=wt,e});!function(e){e[e.ColumnMajor=0]="ColumnMajor",e[e.RowMajor=1]="RowMajor",e[e.Count=2]="Count"}(c||(c={})),function(e){e[e.Diffuse=0]="Diffuse",e[e.Normal=1]="Normal",e[e.Specular=2]="Specular",e[e.MetaIndex=3]="MetaIndex",e[e.Count=4]="Count"}(f||(f={})),function(e){e[e.RGBA32=0]="RGBA32",e[e.RGB24=1]="RGB24",e[e.BC1=2]="BC1",e[e.BC3=3]="BC3",e[e.BC4=4]="BC4",e[e.BC5=5]="BC5",e[e.ETC1_RGB=6]="ETC1_RGB",e[e.RGBA_FLOAT32=7]="RGBA_FLOAT32",e[e.UNC1=8]="UNC1",e[e.JPEG=9]="JPEG",e[e.PNG=10]="PNG",e[e.BMP=11]="BMP",e[e.PSD=12]="PSD",e[e.TGA=13]="TGA",e[e.GIF=14]="GIF",e[e.HDR=15]="HDR",e[e.PIC=16]="PIC",e[e.PNM=17]="PNM",e[e.ASTC_4X4=18]="ASTC_4X4",e[e.ASTC_5X4=19]="ASTC_5X4",e[e.ASTC_5X5=20]="ASTC_5X5",e[e.ASTC_6X5=21]="ASTC_6X5",e[e.ASTC_6X6=22]="ASTC_6X6",e[e.ASTC_8X5=23]="ASTC_8X5",e[e.ASTC_8X6=24]="ASTC_8X6",e[e.ASTC_10X5=25]="ASTC_10X5",e[e.ASTC_10X6=26]="ASTC_10X6",e[e.ASTC_8X8=27]="ASTC_8X8",e[e.ASTC_10X8=28]="ASTC_10X8",e[e.ASTC_10X10=29]="ASTC_10X10",e[e.ASTC_12X10=30]="ASTC_12X10",e[e.ASTC_12X12=31]="ASTC_12X12",e[e.ARGB32=32]="ARGB32",e[e.R8=33]="R8",e[e.PVRTC1_RGB4=34]="PVRTC1_RGB4",e[e.PVRTC1_RGBA4=35]="PVRTC1_RGBA4",e[e.UINT8=36]="UINT8",e[e.UINT16=37]="UINT16",e[e.UINT32=38]="UINT32",e[e.RGB565=39]="RGB565",e[e.RG8=40]="RG8",e[e.RG16F=41]="RG16F",e[e.OPENEXR=42]="OPENEXR",e[e.RGBA_FLOAT16=43]="RGBA_FLOAT16",e[e.RGB_FLOAT16=44]="RGB_FLOAT16",e[e.RGB_FLOAT32=45]="RGB_FLOAT32",e[e.Count=46]="Count"}(d||(d={})),function(e){e[e.Linear=0]="Linear",e[e.SRGB=1]="SRGB",e[e.Count=2]="Count"}(m||(m={})),function(e){e[e.Debug=0]="Debug",e[e.Info=1]="Info",e[e.Warning=2]="Warning",e[e.Error=3]="Error",e[e.Count=4]="Count"}(h||(h={})),function(e){e[e.Inactive=0]="Inactive",e[e.Active=1]="Active",e[e.Complete=2]="Complete",e[e.Error=3]="Error",e[e.Count=4]="Count"}(p||(p={})),function(e){e[e.Found=0]="Found",e[e.Not_Found=1]="Not_Found",e[e.Transfer_Not_Complete=2]="Transfer_Not_Complete",e[e.Buffer_Too_Small=3]="Buffer_Too_Small",e[e.Count=4]="Count"}(y||(y={})),function(e){e[e.Get=0]="Get",e[e.Post=1]="Post",e[e.Put=2]="Put",e[e.Delete=3]="Delete",e[e.Count=4]="Count"}(b||(b={})),function(e){e[e.Version=0]="Version",e[e.Copyright=1]="Copyright",e[e.BuildTime=2]="BuildTime",e[e.BuildId=3]="BuildId",e[e.Count=4]="Count"}(v||(v={})),function(e){e[e.InvalidUserPointer=0]="InvalidUserPointer"}(g||(g={})),function(e){e[e.None=0]="None",e[e.BC1=1]="BC1",e[e.BC2=2]="BC2",e[e.BC3=4]="BC3",e[e.BC4=8]="BC4",e[e.BC5=16]="BC5",e[e.BC6H=32]="BC6H",e[e.BC7=64]="BC7",e[e.ASTC=128]="ASTC",e[e.ETC1=256]="ETC1",e[e.ETC2=512]="ETC2",e[e.EAC_R=1024]="EAC_R",e[e.EAC_RG=2048]="EAC_RG",e[e.PVRTC1=4096]="PVRTC1",e[e.PVRTC2=8192]="PVRTC2",e[e.ATC=16384]="ATC",e[e.HalfFloat=32768]="HalfFloat",e[e.Float=65536]="Float",e[e.All=4294967295]="All"}(w||(w={})),function(e){e[e.NeverUnload=1]="NeverUnload",e[e.ExclusiveRendering=2]="ExclusiveRendering",e[e.UmbraDebug=-2147483648]="UmbraDebug"}(S||(S={})),function(e){e[e.Connected=0]="Connected",e[e.Connecting=1]="Connecting",e[e.ConnectionError=2]="ConnectionError",e[e.Count=3]="Count"}(C||(C={})),function(e){e[e.ZeroToOne=0]="ZeroToOne",e[e.MinusOneToOne=1]="MinusOneToOne",e[e.Count=2]="Count"}(T||(T={})),function(e){e[e.Sphere=0]="Sphere",e[e.Cylinder=1]="Cylinder",e[e.Count=2]="Count"}(A||(A={})),function(e){e[e.InProgress=0]="InProgress",e[e.Done=1]="Done",e[e.Error=2]="Error",e[e.Count=3]="Count"}(U||(U={})),function(e){e[e.File=0]="File",e[e.Directory=1]="Directory",e[e.Cloud=2]="Cloud",e[e.FormatObj=3]="FormatObj",e[e.Count=4]="Count"}(_||(_={})),function(e){e[e.Directory=0]="Directory",e[e.Cloud=1]="Cloud",e[e.Count=2]="Count"}(B||(B={})),function(e){e[e.Material=0]="Material",e[e.Texture=1]="Texture",e[e.Mesh=2]="Mesh",e[e.Count=3]="Count"}(E||(E={})),function(e){e[e.UncachedMemory=1]="UncachedMemory"}(x||(x={})),function(e){e[e.Position=0]="Position",e[e.TextureCoordinate=1]="TextureCoordinate",e[e.Normal=2]="Normal",e[e.Tangent=3]="Tangent",e[e.Count=4]="Count"}(L||(L={})),function(e){e[e.Failure=0]="Failure",e[e.OutOfMemory=1]="OutOfMemory",e[e.Aborted=2]="Aborted",e[e.Success=3]="Success",e[e.Count=4]="Count"}(R||(R={}));var P=Object.freeze({get AssetType(){return E},get AssetLoadResult(){return R}}),F=new Map([[Float32Array,"HEAPF32"],[Uint32Array,"HEAPU32"],[Uint16Array,"HEAPU16"],[Uint8Array,"HEAPU8"]]);function G(e){if(!Number.isInteger(e))throw new Error("Value was not integer: "+e.toString())}var D=function(e){class t{constructor(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Float32Array;if(this.ofs=void 0,this.size=void 0,this.type=void 0,G(t/n.BYTES_PER_ELEMENT),0===t)throw new Error("Buffer size was zero");if(this.ofs=e._malloc(t),0===this.ofs)throw new Error("Allocation of ".concat(t," bytes failed."));this.size=t,this.type=n}destroy(){e._free(this.ofs),this.ofs=0,this.size=0}ensureSize(t){if(this.size<t){if(this.destroy(),this.ofs=e._malloc(t),0===this.ofs)throw new Error("Buffer growth to ".concat(t," bytes failed."));this.size=t}}floats(){return new Float32Array(e.HEAPF32.buffer,this.ofs,this.size/4)}bytes(){return new Uint8Array(e.HEAPU8.buffer,this.ofs,this.size)}}class n{constructor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.size,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.type;this.ofs=void 0,this.start=void 0,this.size=void 0,this.type=void 0,this.heapName=void 0,this.ofs=e.ofs,this.start=t,this.size=n,this.type=r,this.heapName=F.get(r)}getArray(){return new this.type(e[this.heapName].buffer,this.ofs+this.start,this.size/this.type.BYTES_PER_ELEMENT)}}var r=e.getRenderableMemberOffsets();new t(24);function a(e,t){for(var n=0;n<16;n++)e[n]=t[n]}class i{constructor(){this.ptr=void 0,this.configPtr=void 0,this.configPtr=e._malloc(e.CONFIG_SIZE),e.configInit(this.configPtr),this.ptr=e.clientCreate("UmbraJS",this.configPtr)}destroy(){e.clientDestroy(this.ptr),e._free(this.configPtr),this.ptr=0}}class o{constructor(n){this.ptr=void 0,this.matrixBuffer=new t(64),this.infoBuffer=new t(e.sceneInfoSize),this.ptr=n}destroy(){this.matrixBuffer.destroy(),e.sceneDestroy(this.ptr)}connectionStatus(){return e.sceneGetConnectionStatus(this.ptr)}getInfo(){return e.sceneGetInfo(this.ptr,this.infoBuffer.ofs),e.deserializeSceneInfo(this.infoBuffer.ofs)}isConnected(){return this.connectionStatus()===C.Connected}setTransform(t){if(!Array.isArray(t))throw new TypeError("Matrix should be an array");if(16!==t.length)throw new TypeError("Matrix should be of size 4x4");a(this.matrixBuffer.floats(),t),e.sceneSetTransform(this.ptr,this.matrixBuffer.ofs)}}class u{constructor(e,n){this.ptr=void 0,this.matrixBuffer=void 0,this.vectorBuffer=void 0,this.lightBuffer=void 0,this.temp=void 0,this.runtimeAssets=void 0,this.ptr=e,this.matrixBuffer=new t(64),this.vectorBuffer=new t(16),this.lightBuffer=new t(384),this.temp=void 0,this.runtimeAssets=n}destroy(){this.matrixBuffer.destroy(),this.vectorBuffer.destroy(),this.lightBuffer.destroy(),this.temp&&this.temp.destroy(),e.viewDestroy(this.ptr)}setCamera(t,n,r){var i,o,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:T.MinusOneToOne,l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:c.ColumnMajor;if(!Array.isArray(t))throw new TypeError("Camera matrix should be an array");if(!Array.isArray(n))throw new TypeError("Position should be an array");if("number"!=typeof r)throw new TypeError("Quality should be a number");if(16!==t.length)throw new TypeError("WorldToClip matrix should be of size 4x4");if(3!==n.length)throw new TypeError("Position vector should be of length 3");if(a(this.matrixBuffer.floats(),t),i=this.vectorBuffer.floats(),o=n,i[0]=o[0],i[1]=o[1],i[2]=o[2],s){if(s.length>32)throw new Error("Too many lights given");for(var f=this.lightBuffer.floats(),d=0;d<s.length;d++)f[3*d+0]=s[d][0],f[3*d+1]=s[d][1],f[3*d+2]=s[d][2]}e.viewUpdateRendering(this.ptr,this.matrixBuffer.ofs,this.vectorBuffer.ofs,u,l,r,this.lightBuffer.ofs,s.length)}getVisible(n){G(n);var a=n*e.renderableSize;(!this.temp||this.temp.size<a)&&(this.temp&&this.temp.destroy(),this.temp=new t(a));var i=this.temp,o=e.renderableSize/4,s=a/4;G(o),G(s);for(var u=function(e,t,n,r){return G(r/4),new e(t.buffer,n+r,s-r/4)},l=u(Uint32Array,e.HEAPU32,i.ofs,r.mesh),c=u(Int32Array,e.HEAP32,i.ofs,r.lodLevel),f=u(Uint32Array,e.HEAPU32,i.ofs,r.visibilityMask),d=u(Uint32Array,e.HEAPU32,i.ofs,r.scene),m=e.viewNextRenderables(this.ptr,i.ofs,n),h=[],p=0;p<m;p++){var y=l[o*p],b=c[o*p],v=f[o*p],g=d[o*p];h.push({id:y,mesh:this.runtimeAssets.get(y),lod:b,mask:v,scenePtr:g})}return h}}class l{constructor(t){this.ptr=void 0,this.assetType=void 0,this.type=void 0,this.data=void 0,this.ptr=t,this.assetType=e.assetLoadGetType(this.ptr),this.type="Load"+E[this.assetType],this.data={}}prepare(t){e.assetLoadPrepare(this.ptr,t)}finish(t){e.assetLoadFinish(this.ptr,t)}}class f{constructor(t){this.ptr=void 0,this.assetType=void 0,this.type=void 0,this.data=void 0,this.ptr=t,this.assetType=e.assetUnloadGetType(this.ptr),this.type="Unload"+E[this.assetType]}finish(){e.assetUnloadFinish(this.ptr)}get userPointer(){return e.assetUnloadGetUserPointer(this.ptr)}}var m=new Map([["position",new t(4)],["normal",new t(4)],["uv",new t(4)],["tangent",new t(4)],["index",new t(4)]]);class h{constructor(t){this.load=void 0,this.info=void 0,this.vertexBuffers=void 0,this.load=t,e.meshLoadGetInfo(this.load.ptr,h.meshInfoBuffer.ofs),this.info=e.deserializeMeshInfo(h.meshInfoBuffer.ofs)}setBuffers(t){if(h.structBuffer.bytes().fill(0),h.tempDataBuffer.bytes().fill(0),e.serializeElementBuffer(t.position.desc,h.structBuffer.ofs),e.serializeElementBuffer(t.index.desc,h.tempDataBuffer.ofs),"uv"in t&&e.serializeElementBuffer(t.uv.desc,h.structBuffer.ofs+1*e.elementBufferSize),"normal"in t&&e.serializeElementBuffer(t.normal.desc,h.structBuffer.ofs+2*e.elementBufferSize),"tangent"in t&&e.serializeElementBuffer(t.tangent.desc,h.structBuffer.ofs+3*e.elementBufferSize),!e.meshStreamSetBuffers(this.load.ptr,h.structBuffer.ofs,h.tempDataBuffer.ofs))throw console.log(t),new Error("setBuffers failed")}loadNext(){return e.meshStreamNext(this.load.ptr,0,0)}done(){return e.meshStreamDone(this.load.ptr)}allocateBuffers(){var r=this,a=this.info.numUniqueVertices<65536?2:4,i={position:{elemSize:e.vertexAttributeGetElementByteSize(L.Position),count:this.info.numUniqueVertices,mask:1<<L.Position,type:Float32Array},uv:{elemSize:e.vertexAttributeGetElementByteSize(L.TextureCoordinate),count:this.info.numUniqueVertices,mask:1<<L.TextureCoordinate,type:Float32Array},normal:{elemSize:e.vertexAttributeGetElementByteSize(L.Normal),count:this.info.numUniqueVertices,mask:1<<L.Normal,type:Float32Array},tangent:{elemSize:e.vertexAttributeGetElementByteSize(L.Tangent),count:this.info.numUniqueVertices,mask:1<<L.Tangent,type:Float32Array},index:{elemSize:a,count:this.info.numIndices,mask:4294967295,type:2===a?Uint16Array:Uint32Array}},o={};Object.keys(i).forEach((function(e){var t=i[e].count*i[e].elemSize;G(t/i[e].type.BYTES_PER_ELEMENT),o[e]=t}));var s={};return Object.keys(i).forEach((function(e){if(r.info.attributes&i[e].mask){var a=function(e,n,r){var a=m.get(e);return a.size<n?(a.size>0&&a.destroy(),a=new t(n,r),m.set(e,a)):r&&(a.type=r),a}(e,o[e],i[e].type),u={};u.ptr=a.ofs,u.elementByteSize=i[e].elemSize,u.elementCapacity=i[e].count,u.elementStride=i[e].elemSize,u.flags=0,s[e]={data:new n(a,0,o[e]),desc:u}}})),s}}h.structBuffer=new t(e.elementBufferSize*L.Count,Uint8Array),h.meshInfoBuffer=new t(e.meshInfoSize,Uint8Array),h.tempDataBuffer=new t(e.elementBufferSize,Uint8Array);class p{constructor(n,r){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this.assets=new Map,this.client=void 0,this.ptr=void 0,this.platformFeatures=void 0,this.nextId=1,this.loader=void 0,this.tempTextureBuffer=new t(1048576,Uint8Array),this.tempTranscodedBuffer=new t(4,Uint8Array),this.tempStreamingStateBuffer=new t(e.streamingStateSize,Uint8Array),this.scratch=void 0,this.debug=void 0;var i=w.ETC1|w.ASTC|w.PVRTC1|w.BC5,o=r.textureSupportMask;o&i||(o|=w.BC5|w.BC4),this.client=n;var s=e.serializeEnvironmentInfo({textureSupportFlags:o,localCacheDirectory:null,localCacheMaximumByteSize:0},0);this.ptr=e.runtimeCreate(n.ptr,s,a),e._free(s),this.platformFeatures=r;var u=Math.max(e.meshInfoSize,e.materialInfoSize,e.textureInfoSize,e.byteBufferSize);this.scratch=new t(u,Uint8Array),this.debug={textureFormatsInUse:new Set,platformFeatures:r}}destroy(){this.tempTextureBuffer.destroy(),this.scratch.destroy(),e.runtimeDestroy(this.ptr),this.client.destroy(),this.ptr=0}createScenePublic(t){var n=e.sceneCreatePublic(this.ptr,t);if(n)return new o(n)}createSceneLocal(t){var n=e.sceneCreateLocal(this.ptr,t);if(n)return new o(n)}createView(){var t=e.viewCreate(this.ptr);return new u(t,this.assets)}update(){e.runtimeUpdate(this.ptr)}*getAssetUnloads(){for(var t=e.runtimeNextAssetUnload(this.ptr);0!==t;){var n=new f(t);n.data=this.assets.get(n.userPointer),yield n,t=e.runtimeNextAssetUnload(this.ptr)}}*getAssetLoads(){for(var t=this;;){if(this.loader){if(!this.loader.done()){if(!this.loader.loadNext())throw new Error("loadNext failed");yield;continue}var r=this.loader.load;r.data.buffers=this.loader.vertexBuffers,r.data.material=this.assets.get(this.loader.info.material),r.data.bounds=[this.loader.info.bounds.mn,this.loader.info.bounds.mx],this.loader=void 0,yield r}var a=e.runtimeNextAssetLoad(this.ptr);if(0===a)return;var i=new l(a);if("LoadMaterial"===i.type){e.materialLoadGetInfo(i.ptr,this.scratch.ofs);var o=e.deserializeMaterialInfo(this.scratch.ofs),u=o.textures.filter((function(t){return t!==e.INVALID_USERPOINTER}));u=u.map((function(e){return t.assets.get(e)})),i.data={transparent:o.transparent,textures:u},yield i}else if("LoadTexture"===i.type){var c=this.scratch.ofs;e.textureLoadGetInfo(i.ptr,c);var f=e.deserializeTextureInfo(c);f.mipByteSizes=[e.textureGetMipmapLevelByteSize(c,0)],f.mipByteOffsets=[e.textureGetMipmapLevelOffset(c,0)];var m=this.tempTextureBuffer;if(m.ensureSize(f.dataByteSize),e.serializeByteBuffer({ptr:m.ofs,byteSize:f.dataByteSize,flags:0},this.scratch.ofs),!e.textureLoadGetData(i.ptr,this.scratch.ofs))throw new Error("textureLoadGetData failed: ".concat(i.ptr,", ").concat(m.ofs,", ").concat(f.dataByteSize,"/").concat(m.size));var p=new n(m,0,f.dataByteSize);if(this.formatNeedsTranscoding(f.format)){var y;f=this.downsampleAndTranscodeTexture(f,m,this.tempTranscodedBuffer);var b=(s(y={},d.RGBA32,Uint8Array),s(y,d.RGB565,Uint16Array),s(y,d.RG8,Uint8Array),s(y,d.RG16F,Uint16Array),y);(p=new n(this.tempTranscodedBuffer,0,f.dataByteSize)).type=b[f.format]}this.debug.textureFormatsInUse.add(f.format),i.data={info:f,buffer:p},yield i}else{if("LoadMesh"!==i.type)throw new Error("Job wasn't handled correctly");this.loader=new h(i),this.loader.vertexBuffers=this.loader.allocateBuffers(),this.loader.setBuffers(this.loader.vertexBuffers),yield}}}loadAssets(e,t){var n=performance.now();for(var r of this.getAssetUnloads())if(e[r.type](r),performance.now()-n>t)break;for(var a of this.getAssetLoads()){if(a)try{e[a.type](a)}catch(e){throw a.finish(R.Failure),e}if(performance.now()-n>t)break}}addAsset(e){var t=this.nextId;return this.nextId=this.nextId+1|0,0===this.nextId&&(this.nextId=1),this.assets.set(t,e),t}removeAsset(e,t){var n=e.userPointer;return this.assets.has(n)&&this.assets.delete(n),n}formatNeedsTranscoding(e){var t=this.platformFeatures.textureSupportMask;switch(e){case d.BC1:if(t&w.BC1)return!1;break;case d.BC3:if(t&w.BC3)return!1;break;case d.BC4:if(t&w.BC4)return!1;break;case d.BC5:if(t&w.BC5)return!1;break;default:return!1}return!0}downsampleAndTranscodeTexture(t,n,r){var a=e.getUncompressedFromBCFormat(t.format);if(a===d.Count)throw new Error("Couldn't find a matching BC format");a!==d.RG16F||this.platformFeatures.halfFloat||(a=d.RG8);var i=e.getTextureByteSize(t.width,t.height,a);r.ensureSize(i);var o=e.downsampleAndTranscodeTexture(t.format,a,t.width,t.height,n.ofs,t.dataByteSize,r.ofs,r.size);if(!o.success)throw new Error("Texture transcoding failed. Input: ".concat(t.format,", output: ").concat(a,", output size: ").concat(i));if(o.texture.format!==a)throw new Error("Transcoded texture format was ".concat(o.texture.format," instead of the expected ").concat(a));var s=Object.assign({},t),u=o.texture;return s=Object.assign(s,{format:u.format,width:u.width,height:u.height,dataByteSize:u.dataByteSize,mipByteSizes:[u.dataByteSize]})}getStreamingState(){return e.runtimeGetStreamingState(this.ptr,this.tempStreamingStateBuffer.ofs),e.deserializeStreamingState(this.tempStreamingStateBuffer.ofs)}getStreamingProgress(){var e=this.getStreamingState();return 0==e.numResidentTiles?0:e.numResidentTilesLoaded/e.numResidentTiles}}return{createRuntime:function(e){return new p(new i,e)}}};var I,z=function(e){return e=Object.assign({wasmURL:""},e),new Promise((function(t,n){try{M({locateFile:function(t,n){return t.endsWith("umbra.wasm")&&""!==e.wasmURL?e.wasmURL:n+t}}).then((function(e){delete e.then,e.onAbort=function(e){n(e)},function(e){Object.assign(e,{configInit:e.cwrap("UmbraConfigInit",null,["number"]),clientCreate:e.cwrap("UmbraClientCreate","number",["string","number"]),clientDestroy:e.cwrap("UmbraClientDestroy",null,["number"]),getLibraryInfo:e.cwrap("UmbraGetLibraryInfo","string",["number"]),environmentInfoDefaults:e.cwrap("UmbraEnvironmentInfoDefaults",null,["number"]),runtimeCreate:e.cwrap("UmbraRuntimeCreate","number",["number","number","number"]),runtimeUpdate:e.cwrap("UmbraRuntimeUpdate",null,["number"]),runtimeGetStreamingState:e.cwrap("UmbraRuntimeGetStreamingState",null,["number","number"]),runtimeDestroy:e.cwrap("UmbraRuntimeDestroy",null,["number"]),sceneCreate:e.cwrap("UmbraSceneCreate","number",["number","string","string"]),sceneCreatePublic:e.cwrap("UmbraSceneCreatePublic","number",["number","string"]),sceneCreateLocal:e.cwrap("UmbraSceneCreateLocal","number",["number","string"]),sceneGetConnectionStatus:e.cwrap("UmbraSceneGetConnectionStatus","number",["number"]),sceneGetInfo:e.cwrap("UmbraSceneGetInfo","number",["number","number"]),sceneSetTransform:e.cwrap("UmbraSceneSetTransform",null,["number","number"]),sceneDestroy:e.cwrap("UmbraSceneDestroy",null,["number"]),viewCreate:e.cwrap("UmbraViewCreate","number",["number"]),viewUpdateRendering:e.cwrap("UmbraViewUpdateRendering",null,["number","number","number","number","number","number","number","number"]),viewUpdateFilter:e.cwrap("UmbraViewUpdateFilter",null,["number","number"]),viewGetCompleted:e.cwrap("UmbraViewGetCompleted","number",["number"]),viewNextRenderables:e.cwrap("UmbraViewNextRenderables","number",["number","number","number"]),viewResetRenderables:e.cwrap("UmbraViewResetRenderables",null,["number"]),viewDestroy:e.cwrap("UmbraViewDestroy",null,["number"]),sceneCopyCreate:e.cwrap("UmbraSceneCopyCreate","number",["number","number","number","number","number"]),sceneCopyGetStatus:e.cwrap("UmbraSceneCopyGetStatus","number",["number","number"]),sceneCopyGetError:e.cwrap("UmbraSceneCopyGetError","string",["number"]),sceneCopyDestroy:e.cwrap("UmbraSceneCopyDestroy",null,["number"]),vertexAttributeGetElementByteSize:e.cwrap("UmbraVertexAttributeGetElementByteSize","number",["number"]),runtimeNextAssetLoad:e.cwrap("UmbraRuntimeNextAssetLoad","number",["number"]),assetLoadGetType:e.cwrap("UmbraAssetLoadGetType","number",["number"]),assetLoadPrepare:e.cwrap("UmbraAssetLoadPrepare",null,["number","number"]),assetLoadAbortRequested:e.cwrap("UmbraAssetLoadAbortRequested","number",["number"]),assetLoadFinish:e.cwrap("UmbraAssetLoadFinish",null,["number","number"]),meshLoadGetInfo:e.cwrap("UmbraMeshLoadGetInfo",null,["number","number"]),meshLoadGetData:e.cwrap("UmbraMeshLoadGetData","number",["number","number","number"]),meshStreamSetBuffers:e.cwrap("UmbraMeshStreamSetBuffers","number",["number","number","number"]),meshStreamDone:e.cwrap("UmbraMeshStreamDone","number",["number"]),meshStreamNext:e.cwrap("UmbraMeshStreamNext","number",["number","number","number"]),textureGetMipmapLevelByteSize:e.cwrap("UmbraTextureGetMipmapLevelByteSize","number",["number","number"]),textureGetMipmapLevelOffset:e.cwrap("UmbraTextureGetMipmapLevelOffset","number",["number","number"]),textureLoadGetInfo:e.cwrap("UmbraTextureLoadGetInfo",null,["number","number"]),textureLoadGetData:e.cwrap("UmbraTextureLoadGetData","number",["number","number"]),textureMetaDataLoadGetData:e.cwrap("UmbraTextureMetaDataLoadGetData","number",["number","number"]),textureMetaDataGetClassificationCount:e.cwrap("UmbraTextureMetaDataGetClassificationCount","number",["number","number"]),textureMetaDataGetClassification:e.cwrap("UmbraTextureMetaDataGetClassification","number",["number","number","number"]),textureMetaDataGetClassificationAmount:e.cwrap("UmbraTextureMetaDataGetClassificationAmount","number",["number","number","number"]),materialLoadGetInfo:e.cwrap("UmbraMaterialLoadGetInfo",null,["number","number"]),runtimeNextAssetUnload:e.cwrap("UmbraRuntimeNextAssetUnload","number",["number"]),assetUnloadGetType:e.cwrap("UmbraAssetUnloadGetType","number",["number"]),assetUnloadGetUserPointer:e.cwrap("UmbraAssetUnloadGetUserPointer","number",["number"]),assetUnloadFinish:e.cwrap("UmbraAssetUnloadFinish",null,["number"])})}(e),t(function(e){var t={getPlatformFeatures:function(e){var t=0,n=new Set,r=!1,a=!1,i=new Map([]),o=[],s=e.getSupportedExtensions();for(var l of s){var c=l.replace(/^(.*)_WEBGL_/,"WEBGL_");i.set(c,l),o.push(c)}var f=new Map([["WEBGL_compressed_texture_s3tc",{mask:w.BC1|w.BC2|w.BC3,names:["bc1","bc2","bc3"]}],["WEBGL_compressed_texture_s3tc_srgb",{mask:w.BC1|w.BC2|w.BC3,names:["bc1","bc2","bc3"]}],["WEBGL_compressed_texture_rgtc",{mask:w.BC4|w.BC5,names:["bc4","bc5"]}],["WEBGL_compressed_texture_pvrtc",{mask:w.PVRTC1,names:["pvrtc1_rgb4","pvrtc1_rgba4"]}],["WEBGL_compressed_texture_etc1",{mask:w.ETC1,names:["etc1_rgb"]}],["WEBGL_compressed_texture_astc",{mask:w.ASTC,names:["astc_4x4"]}]]);for(var d of f.keys())if(o.includes(d)){e.getExtension(i.get(d));var m=f.get(d);t|=m.mask,m.names.forEach((function(e){return n.add(e)}))}return o.includes("WEBGL_compressed_texture_s3tc_srgb")&&(r=!0),o.includes("EXT_sRGB")&&(e.getExtension(i.get("EXT_sRGB")),r=!0),o.includes("OES_texture_half_float")&&(e.getExtension(i.get("OES_texture_half_float")),a=!0),{textureSupportMask:t,formats:u(n),srgb:r,halfFloat:a}}};return t.nativeModule=e,t.createRuntime=D(e).createRuntime,t.getStreamingInfo=function(){return{minBytesDownloaded:t.nativeModule.minBytesDownloaded,maxBytesDownloaded:t.nativeModule.maxBytesDownloaded}},t.getLibraryInfo=function(){return{version:e.getLibraryInfo(v.Version),copyright:e.getLibraryInfo(v.Copyright),buildTime:e.getLibraryInfo(v.BuildTime),buildID:e.getLibraryInfo(v.BuildId)}},t.abortDownloads=function(){Object.values(e.wgetRequests).forEach((function(e){e.abort()}))},t}(e))}))}catch(e){n(e)}}))};function k(e,t,n){return{format:e,type:t,compressed:n}}var O=(r(I={},d.RGB24,k(t.RGBFormat,t.UnsignedByteType,!1)),r(I,d.RGBA32,k(t.RGBAFormat,t.UnsignedByteType,!1)),r(I,d.RGB565,k(t.RGBFormat,t.UnsignedShort565Type,!1)),r(I,d.RG8,k(t.LuminanceAlphaFormat,t.UnsignedByteType,!1)),r(I,d.RG16F,k(t.LuminanceAlphaFormat,t.HalfFloatType,!1)),r(I,d.BC1,k(t.RGBA_S3TC_DXT1_Format,t.UnsignedByteType,!0)),r(I,d.BC3,k(t.RGBA_S3TC_DXT5_Format,t.UnsignedByteType,!0)),r(I,d.ETC1_RGB,k(t.RGB_ETC1_Format,t.UnsignedByteType,!0)),r(I,d.ASTC_4X4,k(t.RGBA_ASTC_4x4_Format,t.UnsignedByteType,!0)),r(I,d.PVRTC1_RGB4,k(t.RGB_PVRTC_4BPPV1_Format,t.UnsignedByteType,!0)),I);class N{constructor(e){this.flipTangent=void 0,this.defines=void 0,this.flipTangent=!1,this.defines="",e.indexOf("bc3")>-1&&(this.defines+="#define UMBRA_TEXTURE_SUPPORT_BC3\n"),e.indexOf("bc5")>-1&&(this.defines+="#define UMBRA_TEXTURE_SUPPORT_BC5\n"),e.indexOf("astc_4x4")>-1&&(this.defines+="#define UMBRA_TEXTURE_SUPPORT_ASTC\n")}process(e,t){var n=e.fragmentShader;this.flipTangent&&(n="#define UMBRA_FLIP_TANGENT\n"+n),n=(n=(n=(n=this.defines+n).replace("#include <normal_fragment_maps>","\n#ifdef USE_NORMALMAP\n#ifdef USE_TANGENT\n\nvec3 tangentToWorld2 = normal;\nvec3 tangentToWorld0 = normalize(tangent - tangentToWorld2 * dot(tangentToWorld2, tangent));\n\n#ifdef UMBRA_FLIP_TANGENT\nvec3 tangentToWorld1 = normalize(cross(tangentToWorld0, tangentToWorld2));\n#else\nvec3 tangentToWorld1 = normalize(cross(tangentToWorld2, tangentToWorld0));\n#endif\n\n#if defined(UMBRA_TEXTURE_SUPPORT_BC5) || defined(UMBRA_TEXTURE_SUPPORT_ASTC)\nnormal.xy = texture2D(normalMap, vUv).xy * 2.0 - 1.0;\nnormal.z = sqrt(1.0 - clamp(dot(normal.xy, normal.xy), 0.0, 1.0));\n#elif defined(UMBRA_TEXTURE_SUPPORT_BC3)\nnormal.xy = texture2D(normalMap, vUv).yw * 2.0 - 1.0;\nnormal.z = sqrt(1.0 - clamp(dot(normal.xy, normal.xy), 0.0, 1.0));\n#else\nnormal.xyz = texture2D(normalMap, vUv).xyz;\nnormal.xy *= 2.0;\nnormal.xy -= 1.0;\nnormal = normalize(normal);\n#endif\n\nnormal = tangentToWorld0 * normal.x + tangentToWorld1 * normal.y + tangentToWorld2 * normal.z;\nnormal = normalize(normal);\n#endif\n#endif\n\n")).replace("#include <metalnessmap_fragment>","\nfloat metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\nvec4 texelMetalness = texture2D( metalnessMap, vUv );\nmetalnessFactor *= texelMetalness.r;\n#endif\n")).replace("#include <roughnessmap_fragment>","\nfloat roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\nvec4 texelRoughness = texture2D( roughnessMap, vUv );\nfloat roughness = 1.0 - texelRoughness.g;\nroughnessFactor *= roughness;\n#endif\n"),e.fragmentShader=n}}class W{constructor(){this.usedList=[],this.freeList=[]}allocate(e,t){var n;if(this.freeList.length>0)if(void 0===t)n=this.freeList.pop();else for(var r=0;r<this.freeList.length;r++){var a=this.freeList[r];if(t(a)){n=a,this.freeList.splice(r,1);break}}return n||(n=e()),this.usedList.push(n),n}freeAll(e){for(var t=0;t<this.usedList.length;t++)e&&e(this.usedList[t]),this.freeList.push(this.usedList[t]);this.usedList.length=0}clear(){this.usedList.length=0,this.freeList.length=0}}class j extends t.Object3D{set quality(e){console.error("Setting UmbraScene.quality is not supported any more. Set camera.umbraQuality = ".concat(e," instead."))}constructor(e,n,r,a,i){var o,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:void 0;super(),o=this,this.material=new t.MeshBasicMaterial,this.wireframe=!1,this.freeze=!1,this.onConnected=void 0,this.onConnectionError=void 0,this.onDisconnected=void 0,this.onConnectionChanged=void 0,this.onMeshChanged=void 0,this.isLOD=!0,this.autoUpdate=!0,this.name="UmbraScene",this.renderer=void 0,this.materialPool=new W,this.shaderPatcher=void 0,this.sharedState=void 0,this.stats={numVisible:0,numShadowCasters:0,numCachedMaterials:0,numAssets:0},this.diagnostics={missingNormals:{checked:!1,message:"Property umbraScene.opaqueMaterial has been deprecated. Use umbraScene.material instead."},deprecatedMaterial:{checked:!1,message:"UmbraScene has no normals so it will appear black."},report:function(e){o.diagnostics[e].checked||(o.diagnostics[e].checked=!0,console.warn(o.diagnostics[e].message))}},this.umbra=void 0,this.onDispose=void 0,this.oldState={status:void 0,visibleIDs:new Set},this.update=function(e){var n=this;if(!this.freeze){var r=this.sharedState.cameraToView.get(e);if(r||(r=this.umbra.runtime.createView(),this.sharedState.cameraToView.set(e,r)),this.sharedState.viewLastUseFrame.set(r,this.renderer.info.render.frame),this.umbra.nativeScene.setTransform(this.matrixWorld.elements),this.isPBREnabled()){var a=this.matrixWorld.determinant()<0;a!==this.shaderPatcher.flipTangent&&(this.shaderPatcher.flipTangent=a,this.materialPool.clear())}this.stats.numVisible=0,this.stats.numAssets=this.umbra.runtime.assets.size;for(var i=[],o=0;o<this.children.length;o++)this.children[o].isUmbraMesh||i.push(this.children[o]);this.children=i;var s=[],u=new t.Object3D;u.isLOD=!0,u.autoUpdate=!0,u.update=function(e){n.children.pop();for(var t=0;t<s.length;t++)n.children.push(s[t])},this.materialPool.freeAll((function(e){delete e.map,delete e.normalMap,delete e.metalnessMap,delete e.roughnessMap}));var l=[],c=new Set;this.sharedState.viewRenderables.has(r)&&(l=this.sharedState.viewRenderables.get(r));for(var d=function(e){if(l[e].scenePtr!==n.umbra.nativeScene.ptr)return"continue";var r=l[e].mesh,a=r.materialDesc,i=r.geometry;c.add(l[e].id),n.stats.numVisible+=1;var o=a.transparent||n.material.transparent,u=n.materialPool.allocate((function(){return n.material.clone()}),(function(e){return e.transparent===o}));u.wireframe=n.wireframe,u.opacity=n.material.opacity,u.transparent=o,u.onBeforeCompile=function(e,t){n.material.onBeforeCompile&&n.material.onBeforeCompile.apply(u,[e,t]),n.shaderPatcher.process(e,t)};var d=a.textures[f.Diffuse],m=a.textures[f.Normal],h=a.textures[f.Specular];d&&d.isTexture&&(u.map=d),m&&m.isTexture&&(u.normalMap=m,u.vertexTangents=!0,u.normalMapType=t.TangentSpaceNormalMap),h&&h.isTexture&&(u.metalnessMap=h,u.metalness=1,u.roughnessMap=h,u.roughness=1);var p=new t.Mesh(i,u);p.isUmbraMesh=!0,p.matrixWorld.copy(n.matrixWorld),p.castShadow=n.castShadow,p.receiveShadow=n.receiveShadow,p.visible=!0,n.children.push(p),0==(1&l[e].mask)?(s.push(p),p.frustumCulled=!0):(n.children.push(p),p.frustumCulled=!1)},m=0;m<l.length;m++)d(m);if(!this.diagnostics.missingNormals.checked&&this.isPBREnabled())for(var h=0;h<this.children.length;h++)if(this.children[h].isUmbraMesh&&!("normal"in this.children[h].geometry.attributes)){this.diagnostics.report("missingNormals");break}this.stats.numShadowCasters=s.length,this.stats.numCachedMaterials=this.materialPool.usedList.length+this.materialPool.freeList.length,s.length>0&&this.children.push(u),this.updateStreamingEvents(c)}},this.renderer=a,this.sharedState=r,this.shaderPatcher=new N(i.formats),this.onDispose=s,this.scale.set(1,1,-1),this.umbra={runtime:e,nativeScene:n}}get opaqueMaterial(){return this.diagnostics.report("deprecatedMaterial"),this.material}set opaqueMaterial(e){this.diagnostics.report("deprecatedMaterial"),this.material=e}getInfo(){var e={connected:this.umbra.nativeScene.isConnected()};return e.connected&&(e.sceneInfo=this.umbra.nativeScene.getInfo()),Object.assign(e,this.stats),e}getBounds(){if(this.umbra.nativeScene.isConnected()){var e=this.umbra.nativeScene.getInfo().bounds,n=e.mn,r=e.mx;return new t.Box3(new t.Vector3(n[0],n[1],n[2]),new t.Vector3(r[0],r[1],r[2]))}}getCenter(){var e=this.getBounds();e.applyMatrix4(this.matrixWorld);var n=new t.Vector3;return e.getCenter(n),n}updateStreamingEvents(e){var t=this.oldState.visibleIDs,n=e;if(this.onMeshChanged)if(t.size!==n.size)this.onMeshChanged();else for(var r of n)if(!t.has(r)){this.onMeshChanged();break}this.oldState.visibleIDs=e}updateNetworkEvents(){var e=this.umbra.nativeScene.connectionStatus();if(this.oldState.status!==e)switch(this.onConnectionChanged&&this.onConnectionChanged(e),e){case C.ConnectionError:this.onConnectionError&&this.onConnectionError("Could not connect");break;case C.Connected:this.onConnected&&this.onConnected();break;case C.Connecting:this.onDisconnected&&this.onDisconnected()}this.oldState.status=e}dispose(){this.onDispose&&this.onDispose(this),this.children=this.children.filter((function(e){return!e.isUmbraMesh})),this.materialPool.freeAll((function(e){return e.dispose()})),this.umbra.nativeScene.destroy()}isPBREnabled(){return"normalMapType"in this.material}}class V extends t.Loader{constructor(e,t){super(t),this.Umbra=void 0,this.Umbra=e}load(e,t,n,r){var a=this.Umbra.createScene(e);r&&(a.onConnectionError=function(e){r(e)}),a.onConnected=function(){delete a.onConnectionError,n&&n(1),t(a)}}}class q{get memoryUsed(){return this.textureMemoryUsed+this.meshMemoryUsed}constructor(e,n){var r,a=this;this.memoryLimit=524288e3,this.downloadLimit=0,this.qualityFactor=1,this.onStreamingUpdate=void 0,this.onStreamingComplete=void 0,this.umbrajs=void 0,this.runtime=void 0,this.features=void 0,this.renderer=void 0,this.updateTask=void 0,this.assetSizes=new Map,this.textureMemoryUsed=0,this.meshMemoryUsed=0,this.lastQualityLowerFrame=-1,this.umbraScenes=new Set,this.oldState={progress:0,downloadLimitReached:!1},this.sharedState={cameraToView:new Map,viewRenderables:new Map,viewLastUseFrame:new Map},this.tempVector=new t.Vector3,this.dirVector=new t.Vector3,this.matrixWorldInverse=new t.Matrix4,this.projScreenMatrix=new t.Matrix4,this.cameraWorldPosition=new t.Vector3,this.handlers={LoadMaterial:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){var t=e.data;t.transparent=!!e.data.transparent,e.prepare(a.runtime.addAsset(t)),e.finish(P.AssetLoadResult.Success)})),UnloadMaterial:function(e){a.runtime.removeAsset(e,e.data),e.finish()},LoadTexture:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){var n,r=e.data.info,i=e.data.buffer;if(O.hasOwnProperty(r.format)&&(n=O[r.format]),!n)return console.log("Unknown texture format",r.format),void a.runtime.addAsset({isTexture:!1});if(!a.canFitInMemory(i.size))return e.finish(P.AssetLoadResult.OutOfMemory),void a.adjustQuality(.8);var o=a.makeTexture(r,i,n),s=!1;"outputEncoding"in a.renderer?s=a.renderer.outputEncoding===t.sRGBEncoding:"gammaOutput"in a.renderer&&(s=a.renderer.gammaOutput),r.type!==f.Diffuse||s?o.encoding=r.colorSpace===m.Linear?t.LinearEncoding:t.sRGBEncoding:o.encoding=t.LinearEncoding,o.needsUpdate=!0,a.textureMemoryUsed+=i.size,a.assetSizes.set(o,i.size),e.prepare(a.runtime.addAsset(o)),e.finish(P.AssetLoadResult.Success)})),UnloadTexture:function(e){e.data.isTexture&&e.data.dispose(),a.assetSizes.has(e.data)&&(a.textureMemoryUsed-=a.assetSizes.get(e.data),a.assetSizes.delete(e.data)),a.runtime.removeAsset(e,e.data),e.finish()},LoadMesh:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){var n={position:{components:3},normal:{components:3},uv:{components:2},tangent:{components:3}},r=0;if(Object.keys(n).map((function(t){return e.data.buffers[t]})).forEach((function(e){e&&(r+=e.data.size)})),!a.canFitInMemory(r))return e.finish(P.AssetLoadResult.OutOfMemory),void a.adjustQuality(.8);var i,o,s,u,l,c=new t.BufferGeometry,f=e.data.buffers.index.data.getArray(),d=Array.from(f);c.setIndex(d),c.boundingSphere=(i=e.data.bounds,o=i[0],s=i[1],u=new t.Vector3(s[0]-o[0],s[1]-o[1],s[2]-o[2]),l=new t.Vector3(o[0]+.5*u.x,o[1]+.5*u.y,o[2]+.5*u.z),new t.Sphere(l,u.length())),Object.keys(n).forEach((function(r){var a=e.data.buffers[r];if(a){var i=a.data.getArray(),o=new t.Float32BufferAttribute(i.slice(),n[r].components);"setAttribute"in c?c.setAttribute(r,o):c.addAttribute(r,o)}}));var m={geometry:c,materialDesc:e.data.material};a.meshMemoryUsed+=r,a.assetSizes.set(m,r),e.prepare(a.runtime.addAsset(m)),e.finish(P.AssetLoadResult.Success)})),UnloadMesh:function(e){var t=e.data;a.assetSizes.has(e.data)&&(a.meshMemoryUsed-=a.assetSizes.get(e.data),a.assetSizes.delete(e.data)),a.runtime.removeAsset(e,t),t.geometry.dispose(),e.finish()}},r="getContext"in n?n.getContext():n.context;var i=e.getPlatformFeatures(r);i.textureSupportMask&=~w.BC5,this.umbrajs=e,this.runtime=e.createRuntime(i),this.renderer=n,this.features=i,this.startEventUpdate(1e3/60)}startEventUpdate(e){var t=this;this.stopEventUpdate(),this.updateTask=window.setInterval((function(){t.updateEvents(),t.umbraScenes.forEach((function(e){return e.updateNetworkEvents()}))}),e)}stopEventUpdate(){void 0!==this.updateTask&&(window.clearInterval(this.updateTask),delete this.updateTask)}findLights(e){var t;if(e.traverseAncestors((function(e){e.isScene&&(t=e)})),!t||t&&!t.isScene)return new Set;var n=new Set;return t.traverseVisible((function(e){e.isDirectionalLight&&e.castShadow&&n.add(e)})),n}pruneOldViews(e){for(var t of this.sharedState.viewLastUseFrame){var n=a(t,2),r=n[0];if(!(e-n[1]<600)){for(var i of this.sharedState.cameraToView){var o=a(i,2),s=o[0];if(o[1]===r){this.sharedState.cameraToView.delete(s);break}}r.destroy(),this.sharedState.viewLastUseFrame.delete(r)}}}updateViews(){var e=this.sharedState,t=new Set;if(this.renderer.shadowMap.enabled)for(var n of this.umbraScenes)for(var r of this.findLights(n))t.add(r);var o=this.dirVector,s=this.tempVector,u=Array.from(t).map((function(e){return o.setFromMatrixPosition(e.target.matrixWorld),s.setFromMatrixPosition(e.matrixWorld),o.sub(s),[o.x,o.y,o.z]}),t);for(var l of(this.pruneOldViews(this.renderer.info.render.frame),e.cameraToView)){var c=a(l,2),f=c[0],d=c[1],m=f;this.matrixWorldInverse.getInverse(m.matrixWorld),this.projScreenMatrix.multiplyMatrices(m.projectionMatrix,this.matrixWorldInverse),"umbraStreamingPosition"in m?this.cameraWorldPosition.copy(m.umbraStreamingPosition):m.getWorldPosition(this.cameraWorldPosition);var h=.5;"umbraQuality"in m&&(h=m.umbraQuality);var p=this.cameraWorldPosition;d.setCamera(this.projScreenMatrix.elements,[p.x,p.y,p.z],h*this.qualityFactor,u);var y=[];e.viewRenderables.has(d)?(y=e.viewRenderables.get(d)).length=0:e.viewRenderables.set(d,y);var b=[];do{var v;b=d.getVisible(500),(v=y).push.apply(v,i(b))}while(500===b.length)}}update(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:7,t=0!==this.downloadLimit&&this.getStats().maxBytesDownloaded>=this.downloadLimit;if(t)this.oldState.downloadLimitReached||this.umbrajs.abortDownloads();else{var n=performance.now();this.runtime.update();var r=performance.now()-n;this.runtime.loadAssets(this.handlers,e-r),this.updateViews()}this.oldState.downloadLimitReached=t,this.memoryUsed/this.memoryLimit<.25&&this.adjustQuality(1.1)}createScene(e){var t,r=this;if("string"==typeof e)t=e;else{if("object"!==n(e))throw new TypeError("expected either string or an object argument");if("token"in e&&(console.warn("Connection with {token, projectID, modelID} is deprecated. Use {key, project, model} or a string locator instad."),e.key=e.token,e.project=e.projectID,e.model=e.modelID),!("key"in e&&"project"in e&&"model"in e))throw new Error('createScene() expects an object with properties "key", "project", and "model"');t="key=".concat(e.key,"&project=").concat(e.project,"&model=").concat(e.model)}var a=new j(this.runtime,this.runtime.createScenePublic(t),this.sharedState,this.renderer,this.features,(function(e){return r.umbraScenes.delete(e)}));return this.umbraScenes.add(a),a}createSceneWithURL(e){var t=this,n=this.runtime.createSceneLocal(e),r=new j(this.runtime,n,this.sharedState,this.renderer,this.features,(function(e){return t.umbraScenes.delete(e)}));return this.umbraScenes.add(r),r}getStats(){return Object.assign(this.umbrajs.getStreamingInfo(),{textureMemoryUsed:this.textureMemoryUsed,meshMemoryUsed:this.meshMemoryUsed})}canFitInMemory(e){return this.memoryUsed+e<this.memoryLimit}adjustQuality(e){this.renderer.info.render.frame!=this.lastQualityLowerFrame&&(this.qualityFactor=Math.max(0,Math.min(1,this.qualityFactor*e)),this.lastQualityLowerFrame=this.renderer.info.render.frame)}makeTexture(e,n,r){var a,i=n.getArray().slice();if(r.compressed){var o={width:e.width,height:e.height,data:i};a=new t.CompressedTexture([o],e.width,e.height)}else a=new t.DataTexture(i,e.width,e.height);return a.format=r.format,a.type=r.type,a.magFilter=t.LinearFilter,a.minFilter=t.LinearFilter,a.anisotropy=0,a}updateEvents(){var e=this.getStreamingProgress();this.oldState.progress!=e&&(this.onStreamingUpdate&&this.onStreamingUpdate(e),1===e&&this.onStreamingComplete&&this.onStreamingComplete()),this.oldState.progress=e}getStreamingProgress(){return this.runtime.getStreamingProgress()}dispose(){for(var e of(this.stopEventUpdate(),this.sharedState.cameraToView.values()))e.destroy();this.umbraScenes.forEach((function(e){return e.dispose()})),this.sharedState.cameraToView.clear(),this.umbraScenes.clear(),this.runtime.assets.forEach((function(e,t){"geometry"in e&&e.geometry.dispose(),"dispose"in e&&e.dispose()})),this.assetSizes.clear(),this.textureMemoryUsed=0,this.meshMemoryUsed=0,this.runtime.destroy(),this.runtime=void 0,function(e){e.abortDownloads();var t=e;try{t.nativeModule._exit(0)}catch(e){if("ExitStatus"!==e.name)throw e}}(this.umbrajs)}}e.Loader=V,e.Scene=j,e.initWithThreeJS=function(e,t){if(!e)throw new TypeError('"renderer" should be of type THREE.WebGLRenderer');return z(t).then((function(t){return new q(t,e)}))},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=umbrajs-three.amd.min.js.map
