define(["module","exports","three"],function(e,t,n){"use strict";var r,a=(r=new URL(e.uri,document.baseURI).href,function(e){var t;e=e||{},t||(t=void 0!==e?e:{});var n,a={};for(n in t)t.hasOwnProperty(n)&&(a[n]=t[n]);t.arguments=[],t.thisProgram="./this.program",t.quit=function(e,t){throw t},t.preRun=[],t.postRun=[];var o="";document.currentScript&&(o=document.currentScript.src),r&&(o=r),o=0!==o.indexOf("blob:")?o.substr(0,o.lastIndexOf("/")+1):"",t.read=function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),t.responseText},t.readAsync=function(e,t,n){var r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=function(){200==r.status||0==r.status&&r.response?t(r.response):n()},r.onerror=n,r.send(null)},t.setWindowTitle=function(e){document.title=e};var i=t.print||("undefined"!=typeof console?console.log.bind(console):"undefined"!=typeof print?print:null),s=t.printErr||("undefined"!=typeof printErr?printErr:"undefined"!=typeof console&&console.warn.bind(console)||i);for(n in a)a.hasOwnProperty(n)&&(t[n]=a[n]);function u(e){var t=w[R>>2];return(e=t+e+15&-16)>Wt()&&on(),w[R>>2]=e,t}a=void 0;var l,c={"f64-rem":function(e,t){return e%t},debugger:function(){}};"object"!=typeof WebAssembly&&s("no native wasm support detected");var f,d=!1;function h(e,t){e||on("Assertion failed: "+t)}function p(e){if("number"==typeof e)var t=!0,n=e;else t=!1,n=e.length;var r=Zt(Math.max(n,1));if(t){for(e=r,h(0==(3&r)),t=r+(-4&n);e<t;e+=4)w[e>>2]=0;for(t=r+n;e<t;)y[e++>>0]=0;return r}return e.subarray||e.slice?g.set(e,r):g.set(new Uint8Array(e),r),r}var m,y,g,v,b,w,T,A,_,C="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function x(e,t,n){var r=t+n;for(n=t;e[n]&&!(n>=r);)++n;if(16<n-t&&e.subarray&&C)return C.decode(e.subarray(t,n));for(r="";t<n;){var a=e[t++];if(128&a){var o=63&e[t++];if(192==(224&a))r+=String.fromCharCode((31&a)<<6|o);else{var i=63&e[t++];65536>(a=224==(240&a)?(15&a)<<12|o<<6|i:(7&a)<<18|o<<12|i<<6|63&e[t++])?r+=String.fromCharCode(a):(a-=65536,r+=String.fromCharCode(55296|a>>10,56320|1023&a))}}else r+=String.fromCharCode(a)}return r}function E(e){return e?x(g,e,void 0):""}function B(e,t,n,r){if(0<r){r=n+r-1;for(var a=0;a<e.length;++a){var o=e.charCodeAt(a);if(55296<=o&&57343>=o&&(o=65536+((1023&o)<<10)|1023&e.charCodeAt(++a)),127>=o){if(n>=r)break;t[n++]=o}else{if(2047>=o){if(n+1>=r)break;t[n++]=192|o>>6}else{if(65535>=o){if(n+2>=r)break;t[n++]=224|o>>12}else{if(n+3>=r)break;t[n++]=240|o>>18,t[n++]=128|o>>12&63}t[n++]=128|o>>6&63}t[n++]=128|63&o}}t[n]=0}}function S(e){for(var t=0,n=0;n<e.length;++n){var r=e.charCodeAt(n);55296<=r&&57343>=r&&(r=65536+((1023&r)<<10)|1023&e.charCodeAt(++n)),127>=r?++t:t=2047>=r?t+2:65535>=r?t+3:t+4}return t}function P(e){return 0<e%65536&&(e+=65536-e%65536),e}function L(){t.HEAP8=y=new Int8Array(m),t.HEAP16=v=new Int16Array(m),t.HEAP32=w=new Int32Array(m),t.HEAPU8=g=new Uint8Array(m),t.HEAPU16=b=new Uint16Array(m),t.HEAPU32=T=new Uint32Array(m),t.HEAPF32=A=new Float32Array(m),t.HEAPF64=_=new Float64Array(m)}"undefined"!=typeof TextDecoder&&new TextDecoder("utf-16le");var R=18464,I=t.TOTAL_MEMORY||134217728;function M(e){for(;0<e.length;){var n=e.shift();if("function"==typeof n)n();else{var r=n.hb;"number"==typeof r?void 0===n.Xa?t.dynCall_v(r):t.dynCall_vi(r,n.Xa):r(void 0===n.Xa?null:n.Xa)}}}5242880>I&&s("TOTAL_MEMORY should be larger than TOTAL_STACK, was "+I+"! (TOTAL_STACK=5242880)"),t.buffer?m=t.buffer:"object"==typeof WebAssembly&&"function"==typeof WebAssembly.Memory?(f=new WebAssembly.Memory({initial:I/65536}),m=f.buffer):m=new ArrayBuffer(I),L(),w[R>>2]=5261376;var U=[],F=[],k=[],O=[],D=!1;function W(){var e=t.preRun.shift();U.unshift(e)}var j=0,z=null,N=null;function G(){var e=V;return String.prototype.startsWith?e.startsWith("data:application/octet-stream;base64,"):0===e.indexOf("data:application/octet-stream;base64,")}t.preloadedImages={},t.preloadedAudios={};var V="umbra.wasm";if(!G()){var q=V;V=t.locateFile?t.locateFile(q,o):o+q}function J(){try{if(t.wasmBinary)return new Uint8Array(t.wasmBinary);if(t.readBinary)return t.readBinary(V);throw"both async and sync fetching of the wasm failed"}catch(e){on(e)}}function H(e){function n(e){t.asm=e.exports,j--,t.monitorRunDependencies&&t.monitorRunDependencies(j),0==j&&(null!==z&&(clearInterval(z),z=null),N&&(e=N,N=null,e()))}function r(e){n(e.instance)}function a(e){return(t.wasmBinary||"function"!=typeof fetch?new Promise(function(e){e(J())}):fetch(V,{credentials:"same-origin"}).then(function(e){if(!e.ok)throw"failed to load wasm binary file at '"+V+"'";return e.arrayBuffer()}).catch(function(){return J()})).then(function(e){return WebAssembly.instantiate(e,o)}).then(e,function(e){s("failed to asynchronously prepare wasm: "+e),on(e)})}var o={env:e,global:{NaN:NaN,Infinity:1/0},"global.Math":Math,asm2wasm:c};if(j++,t.monitorRunDependencies&&t.monitorRunDependencies(j),t.instantiateWasm)try{return t.instantiateWasm(o,n)}catch(e){return s("Module.instantiateWasm callback failed with error: "+e),!1}return function(){if(t.wasmBinary||"function"!=typeof WebAssembly.instantiateStreaming||G()||"function"!=typeof fetch)return a(r);fetch(V,{credentials:"same-origin"}).then(function(e){return WebAssembly.instantiateStreaming(e,o).then(r,function(e){s("wasm streaming compile failed: "+e),s("falling back to ArrayBuffer instantiation"),a(r)})})}(),{}}t.asm=function(e,t){return t.memory=f,t.table=new WebAssembly.Table({initial:541,maximum:541,element:"anyfunc"}),t.__memory_base=1024,t.__table_base=0,H(t)};var X=[function(){alert("Invalid http method.")},function(e,n,r,a,o,i,s,u,l,c,f){return function(e,n,r,a,o,i,s,u,l,c,f){var d=E(e);n=E(n),i=E(i);var h=new XMLHttpRequest;h.open(n,d,!0),("GET"!=n||0!=i.length)&&(h.withCredentials=!0),h.responseType="arraybuffer";var p=function(){var e=Dt;return Dt++,e}();if(h.onload=function(){if(200==h.status){var n=new Uint8Array(h.response),i=t.URLsDownloaded;t.maxBytesDownloaded+=h.response.byteLength,i.has(e)||(i.add(e),t.minBytesDownloaded+=h.response.byteLength),c?n.length!=f?t.dynCall_viii(o,p,r,0):(g.set(n,c),t.dynCall_viiii(a,p,r,null,0)):(i=Zt(n.length),g.set(n,i),t.dynCall_viiii(a,p,r,i,n.length),Qt(i))}else t.dynCall_viii(o,p,r,h.status);delete Ot[p]},h.onerror=function(){t.dynCall_viii(o,p,r,h.status),delete Ot[p]},h.onabort=function(){delete Ot[p]},0!=i.length&&h.setRequestHeader("Authorization","Basic "+btoa(i+":")),2<=(l=E(l).split("\n")).length)for(d=0;d<l.length;d+=2)h.setRequestHeader(l[d],l[d+1]);return"POST"==n?h.send(y.slice(s,s+u)):h.send(null),Ot[p]=h,p}(e,n,r,a,o,i,s,u,l,c,f)},function(){alert("Uploads are not supported.")}];F.push({hb:function(){en()}});var K={},Y=[null,[],[]],$=0;function Q(){return w[($+=4)-4>>2]}var Z={},ee={};function te(e){for(;e.length;){var t=e.pop();e.pop()(t)}}function ne(e){return this.fromWireType(T[e>>2])}var re={},ae={},oe={};function ie(e){if(void 0===e)return"_unknown";var t=(e=e.replace(/[^a-zA-Z0-9_]/g,"$")).charCodeAt(0);return 48<=t&&57>=t?"_"+e:e}function se(e,t){return e=ie(e),new Function("body","return function "+e+'() {\n    "use strict";    return body.apply(this, arguments);\n};\n')(t)}function ue(e){var t=Error,n=se(e,function(t){this.name=e,this.message=t,void 0!==(t=Error(t).stack)&&(this.stack=this.toString()+"\n"+t.replace(/^Error(:[^\n]*)?\n/,""))});return n.prototype=Object.create(t.prototype),n.prototype.constructor=n,n.prototype.toString=function(){return void 0===this.message?this.name:this.name+": "+this.message},n}var le=void 0;function ce(e){throw new le(e)}function fe(e,t,n){function r(t){(t=n(t)).length!==e.length&&ce("Mismatched type converter count");for(var r=0;r<e.length;++r)ge(e[r],t[r])}e.forEach(function(e){oe[e]=t});var a=Array(t.length),o=[],i=0;t.forEach(function(e,t){ae.hasOwnProperty(e)?a[t]=ae[e]:(o.push(e),re.hasOwnProperty(e)||(re[e]=[]),re[e].push(function(){a[t]=ae[e],++i===o.length&&r(a)}))}),0===o.length&&r(a)}function de(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+e)}}var he=void 0;function pe(e){for(var t="";g[e];)t+=he[g[e++]];return t}var me=void 0;function ye(e){throw new me(e)}function ge(e,t,n){if(n=n||{},!("argPackAdvance"in t))throw new TypeError("registerType registeredInstance requires argPackAdvance");var r=t.name;if(e||ye('type "'+r+'" must have a positive integer typeid pointer'),ae.hasOwnProperty(e)){if(n.wb)return;ye("Cannot register type '"+r+"' twice")}ae[e]=t,delete oe[e],re.hasOwnProperty(e)&&(t=re[e],delete re[e],t.forEach(function(e){e()}))}function ve(e){return{count:e.count,Sa:e.Sa,Va:e.Va,Ja:e.Ja,La:e.La,Ma:e.Ma,Oa:e.Oa}}function be(e){ye(e.Ia.La.Ka.name+" instance already deleted")}var we=!1;function Te(){}function Ae(e){--e.count.value,0===e.count.value&&(e.Ma?e.Oa.Ra(e.Ma):e.La.Ka.Ra(e.Ja))}function _e(e){return"undefined"==typeof FinalizationGroup?(_e=function(e){return e},e):(we=new FinalizationGroup(function(e){for(var t=e.next();!t.done;t=e.next())(t=t.value).Ja?Ae(t):console.warn("object already deleted: "+t.Ja)}),Te=function(e){we.unregister(e.Ia)},(_e=function(e){return we.register(e,e.Ia,e.Ia),e})(e))}var Ce=void 0,xe=[];function Ee(){for(;xe.length;){var e=xe.pop();e.Ia.Sa=!1,e.delete()}}function Be(){}var Se={};function Pe(e,n,r){t.hasOwnProperty(e)?((void 0===r||void 0!==t[e].Qa&&void 0!==t[e].Qa[r])&&ye("Cannot register public name '"+e+"' twice"),function(e,n){var r=t;if(void 0===r[e].Qa){var a=r[e];r[e]=function(){return r[e].Qa.hasOwnProperty(arguments.length)||ye("Function '"+n+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+r[e].Qa+")!"),r[e].Qa[arguments.length].apply(this,arguments)},r[e].Qa=[],r[e].Qa[a.lb]=a}}(e,e),t.hasOwnProperty(r)&&ye("Cannot register multiple overloads of a function with the same number of arguments ("+r+")!"),t[e].Qa[r]=n):(t[e]=n,void 0!==r&&(t[e].Qb=r))}function Le(e,t,n,r,a,o,i,s){this.name=e,this.constructor=t,this.Ua=n,this.Ra=r,this.Pa=a,this.qb=o,this.Wa=i,this.ob=s}function Re(e,t,n){for(;t!==n;)t.Wa||ye("Expected null or instance of "+n.name+", got an instance of "+t.name),e=t.Wa(e),t=t.Pa;return e}function Ie(e,t){return null===t?(this.ab&&ye("null is not a valid "+this.name),0):(t.Ia||ye('Cannot pass "'+Ke(t)+'" as a '+this.name),t.Ia.Ja||ye("Cannot pass deleted object as a pointer of type "+this.name),Re(t.Ia.Ja,t.Ia.La.Ka,this.Ka))}function Me(e,t){if(null===t){if(this.ab&&ye("null is not a valid "+this.name),this.Za){var n=this.bb();return null!==e&&e.push(this.Ra,n),n}return 0}if(t.Ia||ye('Cannot pass "'+Ke(t)+'" as a '+this.name),t.Ia.Ja||ye("Cannot pass deleted object as a pointer of type "+this.name),!this.Ya&&t.Ia.La.Ya&&ye("Cannot convert argument of type "+(t.Ia.Oa?t.Ia.Oa.name:t.Ia.La.name)+" to parameter type "+this.name),n=Re(t.Ia.Ja,t.Ia.La.Ka,this.Ka),this.Za)switch(void 0===t.Ia.Ma&&ye("Passing raw pointer to smart pointer is illegal"),this.Eb){case 0:t.Ia.Oa===this?n=t.Ia.Ma:ye("Cannot convert argument of type "+(t.Ia.Oa?t.Ia.Oa.name:t.Ia.La.name)+" to parameter type "+this.name);break;case 1:n=t.Ia.Ma;break;case 2:if(t.Ia.Oa===this)n=t.Ia.Ma;else{var r=t.clone();n=this.Ab(n,Je(function(){r.delete()})),null!==e&&e.push(this.Ra,n)}break;default:ye("Unsupporting sharing policy")}return n}function Ue(e,t){return null===t?(this.ab&&ye("null is not a valid "+this.name),0):(t.Ia||ye('Cannot pass "'+Ke(t)+'" as a '+this.name),t.Ia.Ja||ye("Cannot pass deleted object as a pointer of type "+this.name),t.Ia.La.Ya&&ye("Cannot convert argument of type "+t.Ia.La.name+" to parameter type "+this.name),Re(t.Ia.Ja,t.Ia.La.Ka,this.Ka))}var Fe={};function ke(e,t){return t.La&&t.Ja||ce("makeClassHandle requires ptr and ptrType"),!!t.Oa!=!!t.Ma&&ce("Both smartPtrType and smartPtr must be specified"),t.count={value:1},_e(Object.create(e,{Ia:{value:t}}))}function Oe(e,t,n,r){this.name=e,this.Ka=t,this.ab=n,this.Ya=r,this.Za=!1,this.Ra=this.Ab=this.bb=this.kb=this.Eb=this.yb=void 0,void 0!==t.Pa?this.toWireType=Me:(this.toWireType=r?Ie:Ue,this.Na=null)}function De(e,n,r){t.hasOwnProperty(e)||ce("Replacing nonexistant public symbol"),void 0!==t[e].Qa&&void 0!==r?t[e].Qa[r]=n:(t[e]=n,t[e].lb=r)}function We(e,n){if(e=pe(e),void 0!==t["FUNCTION_TABLE_"+e])var r=t["FUNCTION_TABLE_"+e][n];else if("undefined"!=typeof FUNCTION_TABLE)r=FUNCTION_TABLE[n];else{void 0===(r=t["dynCall_"+e])&&void 0===(r=t["dynCall_"+e.replace(/f/g,"d")])&&ye("No dynCall invoker for signature: "+e);for(var a=[],o=1;o<e.length;++o)a.push("a"+o);o="return function dynCall_"+e+"_"+n+"("+a.join(", ")+") {\n",o+="    return dynCall(rawFunction"+(a.length?", ":"")+a.join(", ")+");\n",r=new Function("dynCall","rawFunction",o+"};\n")(r,n)}return"function"!=typeof r&&ye("unknown function pointer with signature "+e+": "+n),r}var je=void 0;function ze(e){var t=pe(e=Xt(e));return Qt(e),t}function Ne(e,t){var n=[],r={};throw t.forEach(function e(t){r[t]||ae[t]||(oe[t]?oe[t].forEach(e):(n.push(t),r[t]=!0))}),new je(e+": "+n.map(ze).join([", "]))}var Ge=[],Ve=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function qe(e){4<e&&0==--Ve[e].cb&&(Ve[e]=void 0,Ge.push(e))}function Je(e){switch(e){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var t=Ge.length?Ge.pop():Ve.length;return Ve[t]={cb:1,value:e},t}}function He(e,t,n){switch(t){case 0:return function(e){return this.fromWireType((n?y:g)[e])};case 1:return function(e){return this.fromWireType((n?v:b)[e>>1])};case 2:return function(e){return this.fromWireType((n?w:T)[e>>2])};default:throw new TypeError("Unknown integer type: "+e)}}function Xe(e,t){var n=ae[e];return void 0===n&&ye(t+" has unknown type "+ze(e)),n}function Ke(e){if(null===e)return"null";var t=typeof e;return"object"===t||"array"===t||"function"===t?e.toString():""+e}function Ye(e,t){switch(t){case 2:return function(e){return this.fromWireType(A[e>>2])};case 3:return function(e){return this.fromWireType(_[e>>3])};default:throw new TypeError("Unknown float type: "+e)}}function $e(e){var t=Function;if(!(t instanceof Function))throw new TypeError("new_ called with constructor type "+typeof t+" which is not a function");var n=se(t.name||"unknownFunctionName",function(){});return n.prototype=t.prototype,n=new n,(e=t.apply(n,e))instanceof Object?e:n}function Qe(e,t,n){switch(t){case 0:return n?function(e){return y[e]}:function(e){return g[e]};case 1:return n?function(e){return v[e>>1]}:function(e){return b[e>>1]};case 2:return n?function(e){return w[e>>2]}:function(e){return T[e>>2]};default:throw new TypeError("Unknown integer type: "+e)}}var Ze={};function et(e){var t=Ze[e];return void 0===t?pe(e):t}var tt=[];function nt(e){return e||ye("Cannot use deleted val. handle = "+e),Ve[e].value}function rt(){on()}var at,ot,it,st=null,ut="",lt=0,ct=null,ft=0,dt=0,ht=0,pt=0,mt=[],yt={},gt=!1,vt=!1,bt=[];function wt(){function e(){vt=document.pointerLockElement===t.canvas||document.mozPointerLockElement===t.canvas||document.webkitPointerLockElement===t.canvas||document.msPointerLockElement===t.canvas}if(t.preloadPlugins||(t.preloadPlugins=[]),!Mt){Mt=!0;try{Ut=!0}catch(e){Ut=!1,console.log("warning: no blob constructor, cannot create blobs with mimetypes")}Ft="undefined"!=typeof MozBlobBuilder?MozBlobBuilder:"undefined"!=typeof WebKitBlobBuilder?WebKitBlobBuilder:Ut?null:console.log("warning: no BlobBuilder"),kt="undefined"!=typeof window?window.URL?window.URL:window.webkitURL:void 0,t.jb||void 0!==kt||(console.log("warning: Browser does not support creating object URLs. Built-in browser image decoding will not be available."),t.jb=!0),t.preloadPlugins.push({canHandle:function(e){return!t.jb&&/\.(jpg|jpeg|png|bmp)$/i.test(e)},handle:function(e,n,r,a){var o=null;if(Ut)try{(o=new Blob([e],{type:Pt(n)})).size!==e.length&&(o=new Blob([new Uint8Array(e).buffer],{type:Pt(n)}))}catch(e){!function(e){l||(l={}),l[e]||(l[e]=1,s(e))}("Blob constructor present but fails: "+e+"; falling back to blob builder")}o||((o=new Ft).append(new Uint8Array(e).buffer),o=o.getBlob());var i=kt.createObjectURL(o),u=new Image;u.onload=function(){h(u.complete,"Image "+n+" could not be decoded");var a=document.createElement("canvas");a.width=u.width,a.height=u.height,a.getContext("2d").drawImage(u,0,0),t.preloadedImages[n]=a,kt.revokeObjectURL(i),r&&r(e)},u.onerror=function(){console.log("Image "+i+" could not be decoded"),a&&a()},u.src=i}}),t.preloadPlugins.push({canHandle:function(e){return!t.Pb&&e.substr(-4)in{".ogg":1,".wav":1,".mp3":1}},handle:function(e,n,r,a){function o(a){s||(s=!0,t.preloadedAudios[n]=a,r&&r(e))}function i(){s||(s=!0,t.preloadedAudios[n]=new Audio,a&&a())}var s=!1;if(!Ut)return i();try{var u=new Blob([e],{type:Pt(n)})}catch(e){return i()}u=kt.createObjectURL(u);var l=new Audio;l.addEventListener("canplaythrough",function(){o(l)},!1),l.onerror=function(){if(!s){console.log("warning: browser could not fully decode audio "+n+", trying slower base64 approach");for(var t="",r=0,a=0,i=0;i<e.length;i++)for(r=r<<8|e[i],a+=8;6<=a;){var u=r>>a-6&63;a-=6,t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[u]}2==a?(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(3&r)<<4],t+="=="):4==a&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(15&r)<<2],t+="="),l.src="data:audio/x-"+n.substr(-3)+";base64,"+t,o(l)}},l.src=u,function(e){t.noExitRuntime=!0,setTimeout(function(){d||e()},1e4)}(function(){o(l)})}});var n=t.canvas;n&&(n.requestPointerLock=n.requestPointerLock||n.mozRequestPointerLock||n.webkitRequestPointerLock||n.msRequestPointerLock||function(){},n.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock||document.msExitPointerLock||function(){},n.exitPointerLock=n.exitPointerLock.bind(document),document.addEventListener("pointerlockchange",e,!1),document.addEventListener("mozpointerlockchange",e,!1),document.addEventListener("webkitpointerlockchange",e,!1),document.addEventListener("mspointerlockchange",e,!1),t.elementPointerLock&&n.addEventListener("click",function(e){!vt&&t.canvas.requestPointerLock&&(t.canvas.requestPointerLock(),e.preventDefault())},!1))}}var Tt=!1,At=void 0,_t=void 0;function Ct(e,n,r){function a(){gt=!1;var e=o.parentNode;(document.fullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitFullscreenElement||document.webkitCurrentFullScreenElement)===e?(o.exitFullscreen=Et,At&&o.requestPointerLock(),gt=!0,_t?("undefined"!=typeof SDL&&(w[SDL.screen>>2]=8388608|T[SDL.screen>>2]),It(t.canvas),Rt()):It(o)):(e.parentNode.insertBefore(o,e),e.parentNode.removeChild(e),_t?("undefined"!=typeof SDL&&(w[SDL.screen>>2]=-8388609&T[SDL.screen>>2]),It(t.canvas),Rt()):It(o)),t.onFullScreen&&t.onFullScreen(gt),t.onFullscreen&&t.onFullscreen(gt)}void 0===(At=e)&&(At=!0),void 0===(_t=n)&&(_t=!1);var o=t.canvas;Tt||(Tt=!0,document.addEventListener("fullscreenchange",a,!1),document.addEventListener("mozfullscreenchange",a,!1),document.addEventListener("webkitfullscreenchange",a,!1),document.addEventListener("MSFullscreenChange",a,!1));var i=document.createElement("div");o.parentNode.insertBefore(i,o),i.appendChild(o),i.requestFullscreen=i.requestFullscreen||i.mozRequestFullScreen||i.msRequestFullscreen||(i.webkitRequestFullscreen?function(){i.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}:null)||(i.webkitRequestFullScreen?function(){i.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}:null),r?i.requestFullscreen({Sb:r}):i.requestFullscreen()}function xt(e,t,n){s("Browser.requestFullScreen() is deprecated. Please call Browser.requestFullscreen instead."),xt=function(e,t,n){Ct(e,t,n)},Ct(e,t,n)}function Et(){return!!gt&&((document.exitFullscreen||document.cancelFullScreen||document.mozCancelFullScreen||document.msExitFullscreen||document.webkitCancelFullScreen||function(){}).apply(document,[]),!0)}var Bt=0;function St(e){if("function"==typeof requestAnimationFrame)requestAnimationFrame(e);else{var t=Date.now();if(0===Bt)Bt=t+1e3/60;else for(;t+2>=Bt;)Bt+=1e3/60;setTimeout(e,Math.max(Bt-t,0))}}function Pt(e){return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",bmp:"image/bmp",ogg:"audio/ogg",wav:"audio/wav",mp3:"audio/mpeg"}[e.substr(e.lastIndexOf(".")+1)]}var Lt=[];function Rt(){var e=t.canvas;Lt.forEach(function(t){t(e.width,e.height)})}function It(e,n,r){n&&r?(e.Fb=n,e.vb=r):(n=e.Fb,r=e.vb);var a=n,o=r;if(t.forcedAspectRatio&&0<t.forcedAspectRatio&&(a/o<t.forcedAspectRatio?a=Math.round(o*t.forcedAspectRatio):o=Math.round(a/t.forcedAspectRatio)),(document.fullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitFullscreenElement||document.webkitCurrentFullScreenElement)===e.parentNode&&"undefined"!=typeof screen){var i=Math.min(screen.width/a,screen.height/o);a=Math.round(a*i),o=Math.round(o*i)}_t?(e.width!=a&&(e.width=a),e.height!=o&&(e.height=o),void 0!==e.style&&(e.style.removeProperty("width"),e.style.removeProperty("height"))):(e.width!=n&&(e.width=n),e.height!=r&&(e.height=r),void 0!==e.style&&(a!=n||o!=r?(e.style.setProperty("width",a+"px","important"),e.style.setProperty("height",o+"px","important")):(e.style.removeProperty("width"),e.style.removeProperty("height"))))}var Mt,Ut,Ft,kt,Ot={},Dt=0;function Wt(){return y.length}var jt,zt={};function Nt(e,t){var n=zt[e];if(n)t(null,n);else{try{var r=function(){if("undefined"!=typeof indexedDB)return indexedDB;var e=null;return"object"==typeof window&&(e=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB),h(e,"IDBStore used, but indexedDB not supported"),e}().open(e,22)}catch(e){return void t(e)}r.onupgradeneeded=function(e){var t=e.target.result;e=e.target.transaction,t.objectStoreNames.contains("FILE_DATA")?e.objectStore("FILE_DATA"):t.createObjectStore("FILE_DATA")},r.onsuccess=function(){n=r.result,zt[e]=n,t(null,n)},r.onerror=function(e){t(this.error),e.preventDefault()}}}function Gt(e,t,n){Nt(e,function(e,r){if(e)return n(e);(e=r.transaction(["FILE_DATA"],t)).onerror=function(e){n(this.error||"unknown error"),e.preventDefault()},e=e.objectStore("FILE_DATA"),n(null,e)})}B("GMT",g,18368,4),le=t.InternalError=ue("InternalError");for(var Vt=Array(256),qt=0;256>qt;++qt)Vt[qt]=String.fromCharCode(qt);function Jt(e){var t=Array(S(e)+1);return B(e,t,0,t.length),t}he=Vt,me=t.BindingError=ue("BindingError"),Be.prototype.isAliasOf=function(e){if(!(this instanceof Be&&e instanceof Be))return!1;var t=this.Ia.La.Ka,n=this.Ia.Ja,r=e.Ia.La.Ka;for(e=e.Ia.Ja;t.Pa;)n=t.Wa(n),t=t.Pa;for(;r.Pa;)e=r.Wa(e),r=r.Pa;return t===r&&n===e},Be.prototype.clone=function(){if(this.Ia.Ja||be(this),this.Ia.Va)return this.Ia.count.value+=1,this;var e=_e(Object.create(Object.getPrototypeOf(this),{Ia:{value:ve(this.Ia)}}));return e.Ia.count.value+=1,e.Ia.Sa=!1,e},Be.prototype.delete=function(){this.Ia.Ja||be(this),this.Ia.Sa&&!this.Ia.Va&&ye("Object already scheduled for deletion"),Te(this),Ae(this.Ia),this.Ia.Va||(this.Ia.Ma=void 0,this.Ia.Ja=void 0)},Be.prototype.isDeleted=function(){return!this.Ia.Ja},Be.prototype.deleteLater=function(){return this.Ia.Ja||be(this),this.Ia.Sa&&!this.Ia.Va&&ye("Object already scheduled for deletion"),xe.push(this),1===xe.length&&Ce&&Ce(Ee),this.Ia.Sa=!0,this},Oe.prototype.rb=function(e){return this.kb&&(e=this.kb(e)),e},Oe.prototype.fb=function(e){this.Ra&&this.Ra(e)},Oe.prototype.argPackAdvance=8,Oe.prototype.readValueFromPointer=ne,Oe.prototype.deleteObject=function(e){null!==e&&e.delete()},Oe.prototype.fromWireType=function(e){function t(){return this.Za?ke(this.Ka.Ua,{La:this.yb,Ja:n,Oa:this,Ma:e}):ke(this.Ka.Ua,{La:this,Ja:e})}var n=this.rb(e);if(!n)return this.fb(e),null;var r=function(e,t){for(void 0===t&&ye("ptr should not be undefined");e.Pa;)t=e.Wa(t),e=e.Pa;return Fe[t]}(this.Ka,n);if(void 0!==r)return 0===r.Ia.count.value?(r.Ia.Ja=n,r.Ia.Ma=e,r.clone()):(r=r.clone(),this.fb(e),r);if(r=this.Ka.qb(n),!(r=Se[r]))return t.call(this);r=this.Ya?r.nb:r.pointerType;var a=function e(t,n,r){return n===r?t:void 0===r.Pa?null:null===(t=e(t,n,r.Pa))?null:r.ob(t)}(n,this.Ka,r.Ka);return null===a?t.call(this):this.Za?ke(r.Ka.Ua,{La:r,Ja:a,Oa:this,Ma:e}):ke(r.Ka.Ua,{La:r,Ja:a})},t.getInheritedInstanceCount=function(){return Object.keys(Fe).length},t.getLiveInheritedInstances=function(){var e,t=[];for(e in Fe)Fe.hasOwnProperty(e)&&t.push(Fe[e]);return t},t.flushPendingDeletes=Ee,t.setDelayFunction=function(e){Ce=e,xe.length&&Ce&&Ce(Ee)},je=t.UnboundTypeError=ue("UnboundTypeError"),t.count_emval_handles=function(){for(var e=0,t=5;t<Ve.length;++t)void 0!==Ve[t]&&++e;return e},t.get_first_emval=function(){for(var e=5;e<Ve.length;++e)if(void 0!==Ve[e])return Ve[e];return null},t.requestFullScreen=function(e,n,r){s("Module.requestFullScreen is deprecated. Please call Module.requestFullscreen instead."),t.requestFullScreen=t.requestFullscreen,xt(e,n,r)},t.requestFullscreen=function(e,t,n){Ct(e,t,n)},t.requestAnimationFrame=function(e){St(e)},t.setCanvasSize=function(e,n,r){It(t.canvas,e,n),r||Rt()},t.pauseMainLoop=function(){st=null,lt++},t.resumeMainLoop=function(){lt++;var e=dt,n=ht,r=ct;ct=null,function(e){var n=ft;t.noExitRuntime=!0,h(!ct,"emscripten_set_main_loop: there can only be one main loop function at once: call emscripten_cancel_main_loop to cancel the previous one before setting a new one with different parameters."),ct=e,ft=n;var r=void 0!==n?function(){t.dynCall_vi(e,n)}:function(){t.dynCall_v(e)},a=lt;ot=function(){if(!d)if(0<mt.length){var e=Date.now(),n=mt.shift();if(n.hb(n.Xa),it){var o=it,i=0==o%1?o-1:Math.floor(o);it=n.Hb?i:(8*o+(i+.5))/9}console.log('main loop blocker "'+n.name+'" took '+(Date.now()-e)+" ms"),t.setStatus&&(e=t.statusMessage||"Please wait...",n=it,o=yt.Lb,n?n<o?t.setStatus(e+" ("+(o-n)+"/"+o+")"):t.setStatus(e):t.setStatus("")),a<lt||setTimeout(ot,0)}else if(!(a<lt))if(pt=pt+1|0,1==dt&&1<ht&&0!=pt%ht)st();else{0==dt&&(at=rt()),"timeout"===ut&&t.$a&&(s("Looks like you are rendering without using requestAnimationFrame for the main loop. You should use 0 for the frame rate in emscripten_set_main_loop in order to use requestAnimationFrame, as that can greatly improve your frame rates!"),ut="");e:if(!(d||t.preMainLoop&&!1===t.preMainLoop())){try{r()}catch(e){if(e instanceof rn)break e;throw e&&"object"==typeof e&&e.stack&&s("exception thrown: "+[e,e.stack]),e}t.postMainLoop&&t.postMainLoop()}a<lt||("object"==typeof SDL&&SDL.audio&&SDL.audio.zb&&SDL.audio.zb(),st())}}}(r),function(e,t){if(dt=e,ht=t,ct)if(0==e)st=function(){var e=0|Math.max(0,at+t-rt());setTimeout(ot,e)},ut="timeout";else if(1==e)st=function(){St(ot)},ut="rAF";else if(2==e){if("undefined"==typeof setImmediate){var n=[];addEventListener("message",function(e){"setimmediate"!==e.data&&"setimmediate"!==e.data.target||(e.stopPropagation(),n.shift()())},!0),setImmediate=function(e){n.push(e),postMessage("setimmediate","*")}}st=function(){setImmediate(ot)},ut="immediate"}}(e,n),st()},t.getUserMedia=function(){window.getUserMedia||(window.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia),window.getUserMedia(void 0)},t.createContext=function(e,n,r,a){return function(e,n,r,a){if(n&&t.$a&&e==t.canvas)return t.$a;var o;if(n){var i={antialias:!1,alpha:!1,Nb:1};if(a)for(var s in a)i[s]=a[s];if("undefined"!=typeof GL&&(o=GL.Ib(e,i)))var u=GL.getContext(o).Gb}else u=e.getContext("2d");return u?(r&&(n||h("undefined"==typeof GLctx,"cannot set in module if GLctx is used, but we are a non-GL context that would replace it"),t.$a=u,n&&GL.Ob(o),t.Rb=n,bt.forEach(function(e){e()}),wt()),u):null}(e,n,r,a)},rt="undefined"!=typeof dateNow?dateNow:"object"==typeof performance&&performance&&"function"==typeof performance.now?function(){return performance.now()}:Date.now;var Ht=t.asm({},{h:on,y:function(){},aa:function(){s("missing function: _ZN5Umbra18createDirRecursiveEPKc"),on(-1)},Y:function e(n){if(e.mb)var r=w[n>>2],a=w[r>>2];else e.mb=!0,K.USER=K.LOGNAME="web_user",K.PATH="/",K.PWD="/",K.HOME="/home/web_user",K.LANG="C.UTF-8",K._=t.thisProgram,a=D?Zt(1024):u(1024),r=D?Zt(256):u(256),w[r>>2]=a,w[n>>2]=r;n=[];var o,i=0;for(o in K)if("string"==typeof K[o]){var s=o+"="+K[o];n.push(s),i+=s.length}if(1024<i)throw Error("Environment size exceeded TOTAL_ENV_SIZE!");for(o=0;o<n.length;o++){i=s=n[o];for(var l=a,c=0;c<i.length;++c)y[l++>>0]=i.charCodeAt(c);y[l>>0]=0,w[r+4*o>>2]=a,a+=s.length+1}w[r+4*n.length>>2]=0},V:function(){throw d=!0,"Pure virtual function called!"},v:function(){},z:function(e){return t.___errno_location&&(w[t.___errno_location()>>2]=e),e},M:function(e,t){$=t;try{return Z.ib(),Q(),Q(),Q(),Q(),0}catch(e){return on(e),-e.Ta}},L:function(e,t){$=t;try{var n=Z.ib(),r=Q(),a=Q();return Z.Jb(n,r,a)}catch(e){return on(e),-e.Ta}},x:function(e,t){$=t;try{var n=Q(),r=Q(),a=Q();for(t=e=0;t<a;t++){for(var o=w[r+8*t>>2],u=w[r+(8*t+4)>>2],l=0;l<u;l++){var c=g[o+l],f=Y[n];0===c||10===c?((1===n?i:s)(x(f,0)),f.length=0):f.push(c)}e+=u}return e}catch(e){return on(e),-e.Ta}},K:function(e,t){$=t;try{var n=E(Q()),r=Q();return Z.Kb((void 0).stat,n,r)}catch(e){return on(e),-e.Ta}},u:function(e,t){return $=t,0},$:function(e,t){$=t;try{var n=E(Q()),r=Q(),a=Q();return(void 0).open(n,r,a).Mb}catch(e){return on(e),-e.Ta}},J:function(e,t){return $=t,0},I:function(e,t){$=t;try{return Z.ib(),0}catch(e){return on(e),-e.Ta}},w:function(){},t:function(e){var t=ee[e];delete ee[e];var n=t.bb,r=t.Ra,a=t.gb;fe([e],a.map(function(e){return e.ub}).concat(a.map(function(e){return e.Cb})),function(e){var o={};return a.forEach(function(t,n){var r=e[n],i=t.sb,s=t.tb,u=e[n+a.length],l=t.Bb,c=t.Db;o[t.pb]={read:function(e){return r.fromWireType(i(s,e))},write:function(e,t){var n=[];l(c,e,u.toWireType(n,t)),te(n)}}}),[{name:t.name,fromWireType:function(e){var t,n={};for(t in o)n[t]=o[t].read(e);return r(e),n},toWireType:function(e,t){for(var a in o)if(!(a in t))throw new TypeError("Missing field");var i=n();for(a in o)o[a].write(i,t[a]);return null!==e&&e.push(r,i),i},argPackAdvance:8,readValueFromPointer:ne,Na:r}]})},_:function(e,t,n,r,a){var o=de(n);ge(e,{name:t=pe(t),fromWireType:function(e){return!!e},toWireType:function(e,t){return t?r:a},argPackAdvance:8,readValueFromPointer:function(e){if(1===n)var r=y;else if(2===n)r=v;else{if(4!==n)throw new TypeError("Unknown boolean type size: "+t);r=w}return this.fromWireType(r[e>>o])},Na:null})},H:function(e,t,n,r,a,o,i,s,u,l,c,f,d){c=pe(c),o=We(a,o),s&&(s=We(i,s)),l&&(l=We(u,l)),d=We(f,d);var h=ie(c);Pe(h,function(){Ne("Cannot construct "+c+" due to unbound types",[r])}),fe([e,t,n],r?[r]:[],function(t){if(t=t[0],r)var n=t.Ka,a=n.Ua;else a=Be.prototype;t=se(h,function(){if(Object.getPrototypeOf(this)!==i)throw new me("Use 'new' to construct "+c);if(void 0===u.eb)throw new me(c+" has no accessible constructor");var e=u.eb[arguments.length];if(void 0===e)throw new me("Tried to invoke ctor of "+c+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(u.eb).toString()+") parameters instead!");return e.apply(this,arguments)});var i=Object.create(a,{constructor:{value:t}});t.prototype=i;var u=new Le(c,t,i,d,n,o,s,l);n=new Oe(c,u,!0,!1),a=new Oe(c+"*",u,!1,!1);var f=new Oe(c+" const*",u,!1,!0);return Se[e]={pointerType:a,nb:f},De(h,t),[n,a,f]})},Z:function(e,t){ge(e,{name:t=pe(t),fromWireType:function(e){var t=Ve[e].value;return qe(e),t},toWireType:function(e,t){return Je(t)},argPackAdvance:8,readValueFromPointer:ne,Na:null})},s:function(e,t,n,r){function a(){}n=de(n),t=pe(t),a.values={},ge(e,{name:t,constructor:a,fromWireType:function(e){return this.constructor.values[e]},toWireType:function(e,t){return t.value},argPackAdvance:8,readValueFromPointer:He(t,n,r),Na:null}),Pe(t,a)},g:function(e,t,n){var r=Xe(e,"enum");t=pe(t),e=r.constructor,r=Object.create(r.constructor.prototype,{value:{value:n},constructor:{value:se(r.name+"_"+t,function(){})}}),e.values[n]=r,e[t]=r},G:function(e,t,n){n=de(n),ge(e,{name:t=pe(t),fromWireType:function(e){return e},toWireType:function(e,t){if("number"!=typeof t&&"boolean"!=typeof t)throw new TypeError('Cannot convert "'+Ke(t)+'" to '+this.name);return t},argPackAdvance:8,readValueFromPointer:Ye(t,n),Na:null})},d:function(e,t,n,r,a,o){var i=function(e,t){for(var n=[],r=0;r<e;r++)n.push(w[(t>>2)+r]);return n}(t,n);e=pe(e),a=We(r,a),Pe(e,function(){Ne("Cannot call "+e+" due to unbound types",i)},t-1),fe([],i,function(n){var r=e,i=e;n=[n[0],null].concat(n.slice(1));var s=a,u=n.length;2>u&&ye("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var l=null!==n[1]&&!1,c=!1,f=1;f<n.length;++f)if(null!==n[f]&&void 0===n[f].Na){c=!0;break}var d="void"!==n[0].name,h="",p="";for(f=0;f<u-2;++f)h+=(0!==f?", ":"")+"arg"+f,p+=(0!==f?", ":"")+"arg"+f+"Wired";i="return function "+ie(i)+"("+h+") {\nif (arguments.length !== "+(u-2)+") {\nthrowBindingError('function "+i+" called with ' + arguments.length + ' arguments, expected "+(u-2)+" args!');\n}\n",c&&(i+="var destructors = [];\n");var m=c?"destructors":"null";for(h="throwBindingError invoker fn runDestructors retType classParam".split(" "),s=[ye,s,o,te,n[0],n[1]],l&&(i+="var thisWired = classParam.toWireType("+m+", this);\n"),f=0;f<u-2;++f)i+="var arg"+f+"Wired = argType"+f+".toWireType("+m+", arg"+f+"); // "+n[f+2].name+"\n",h.push("argType"+f),s.push(n[f+2]);if(l&&(p="thisWired"+(0<p.length?", ":"")+p),i+=(d?"var rv = ":"")+"invoker(fn"+(0<p.length?", ":"")+p+");\n",c)i+="runDestructors(destructors);\n";else for(f=l?1:2;f<n.length;++f)u=1===f?"thisWired":"arg"+(f-2)+"Wired",null!==n[f].Na&&(i+=u+"_dtor("+u+"); // "+n[f].name+"\n",h.push(u+"_dtor"),s.push(n[f].Na));return d&&(i+="var ret = retType.fromWireType(rv);\nreturn ret;\n"),h.push(i+"}\n"),De(r,n=$e(h).apply(null,s),t-1),[]})},n:function(e,t,n,r,a){function o(e){return e}t=pe(t),-1===a&&(a=4294967295);var i=de(n);if(0===r){var s=32-8*n;o=function(e){return e<<s>>>s}}var u=-1!=t.indexOf("unsigned");ge(e,{name:t,fromWireType:o,toWireType:function(e,n){if("number"!=typeof n&&"boolean"!=typeof n)throw new TypeError('Cannot convert "'+Ke(n)+'" to '+this.name);if(n<r||n>a)throw new TypeError('Passing a number "'+Ke(n)+'" from JS side to C/C++ side to an argument of type "'+t+'", which is outside the valid range ['+r+", "+a+"]!");return u?n>>>0:0|n},argPackAdvance:8,readValueFromPointer:Qe(t,i,0!==r),Na:null})},j:function(e,t,n){function r(e){e>>=2;var t=T;return new a(t.buffer,t[e+1],t[e])}var a=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t];ge(e,{name:n=pe(n),fromWireType:r,argPackAdvance:8,readValueFromPointer:r},{wb:!0})},F:function(e,t){var n="std::string"===(t=pe(t));ge(e,{name:t,fromWireType:function(e){var t=T[e>>2];if(n){var r=g[e+4+t],a=0;0!=r&&(a=r,g[e+4+t]=0);var o=e+4;for(r=0;r<=t;++r){var i=e+4+r;if(0==g[i]){if(o=E(o),void 0===s)var s=o;else s+=String.fromCharCode(0),s+=o;o=i+1}}0!=a&&(g[e+4+t]=a)}else{for(s=Array(t),r=0;r<t;++r)s[r]=String.fromCharCode(g[e+4+r]);s=s.join("")}return Qt(e),s},toWireType:function(e,t){t instanceof ArrayBuffer&&(t=new Uint8Array(t));var r="string"==typeof t;r||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int8Array||ye("Cannot pass non-string to std::string");var a=(n&&r?function(){return S(t)}:function(){return t.length})(),o=Zt(4+a+1);if(T[o>>2]=a,n&&r)B(t,g,o+4,a+1);else if(r)for(r=0;r<a;++r){var i=t.charCodeAt(r);255<i&&(Qt(o),ye("String has UTF-16 code units that do not fit in 8 bits")),g[o+4+r]=i}else for(r=0;r<a;++r)g[o+4+r]=t[r];return null!==e&&e.push(Qt,o),o},argPackAdvance:8,readValueFromPointer:ne,Na:function(e){Qt(e)}})},X:function(e,t,n){if(n=pe(n),2===t)var r=function(){return b},a=1;else 4===t&&(r=function(){return T},a=2);ge(e,{name:n,fromWireType:function(e){for(var t=r(),n=T[e>>2],o=Array(n),i=e+4>>a,s=0;s<n;++s)o[s]=String.fromCharCode(t[i+s]);return Qt(e),o.join("")},toWireType:function(e,n){var o=r(),i=n.length,s=Zt(4+i*t);T[s>>2]=i;for(var u=s+4>>a,l=0;l<i;++l)o[u+l]=n.charCodeAt(l);return null!==e&&e.push(Qt,s),s},argPackAdvance:8,readValueFromPointer:ne,Na:function(e){Qt(e)}})},r:function(e,t,n,r,a,o){ee[e]={name:pe(t),bb:We(n,r),Ra:We(a,o),gb:[]}},i:function(e,t,n,r,a,o,i,s,u,l){ee[e].gb.push({pb:pe(t),ub:n,sb:We(r,a),tb:o,Cb:i,Bb:We(s,u),Db:l})},W:function(e,t){ge(e,{xb:!0,name:t=pe(t),argPackAdvance:0,fromWireType:function(){},toWireType:function(){}})},p:function(e,t,n,r){(e=tt[e])(t=nt(t),n=et(n),null,r)},b:qe,o:function(e,t){for(var n=(t=function(e,t){for(var n=Array(e),r=0;r<e;++r)n[r]=Xe(w[(t>>2)+r],"parameter "+r);return n}(e,t))[0],r=n.name+"_$"+t.slice(1).map(function(e){return e.name}).join("_")+"$",a=["retType"],o=[n],i="",s=0;s<e-1;++s)i+=(0!==s?", ":"")+"arg"+s,a.push("argType"+s),o.push(t[1+s]);r="return function "+ie("methodCaller_"+r)+"(handle, name, destructors, args) {\n";var u=0;for(s=0;s<e-1;++s)r+="    var arg"+s+" = argType"+s+".readValueFromPointer(args"+(u?"+"+u:"")+");\n",u+=t[s+1].argPackAdvance;for(r+="    var rv = handle[name]("+i+");\n",s=0;s<e-1;++s)t[s+1].deleteObject&&(r+="    argType"+s+".deleteObject(arg"+s+");\n");return n.xb||(r+="    return retType.toWireType(destructors, rv);\n"),a.push(r+"};\n"),function(e){var t=tt.length;return tt.push(e),t}(e=$e(a).apply(null,o))},E:function(e){4<e&&(Ve[e].cb+=1)},q:function(){return Je([])},f:function(e){return Je(et(e))},m:function(){return Je({})},c:function(e,t,n){e=nt(e),t=nt(t),n=nt(n),e[t]=n},e:function(e,t){return Je(e=(e=Xe(e,"_emval_take_value")).readValueFromPointer(t))},l:function(){t.abort()},D:function(e){return X[e]()},U:function(e,t,n,r,a,o,i,s,u,l,c,f){return X[e](t,n,r,a,o,i,s,u,l,c,f)},C:function(e){(e=Ot[e])&&e.abort()},T:Wt,k:rt,B:function(e,t,n,r,a){!function(e,t,n){Gt(e,"readonly",function(e,r){if(e)return n(e);(e=r.get(t)).onsuccess=function(e){return(e=e.target.result)?n(null,e):n("file "+t+" not found")},e.onerror=function(e){n(e)}})}(E(e),E(t),function(e,t){e?a&&tn(a,n):(e=Zt(t.length),g.set(t,e),nn(r,n,e,t.length),Qt(e))})},S:function(e,t,n,r,a,o,i){!function(e,t,n,r){Gt(e,"readwrite",function(e,a){if(e)return r(e);(e=a.put(n,t)).onsuccess=function(){r()},e.onerror=function(e){r(e)}})}(E(e),E(t),new Uint8Array(g.subarray(n,n+r)),function(e){e?i&&tn(i,a):o&&tn(o,a)})},R:function(e,t,n){g.set(g.subarray(t,t+n),e)},Q:function(e){if(2147418112<e)return!1;for(var t=Math.max(Wt(),16777216);t<e;)t=536870912>=t?P(2*t):Math.min(P((3*t+2147483648)/4),2147418112);return!!function(e){e=P(e);var t=m.byteLength;try{return-1!==f.grow((e-t)/65536)&&(m=f.buffer,!0)}catch(e){return!1}}(t)&&(L(),!0)},A:function(){on("trap!")},P:function(e){!function(){function e(e){return(e=e.toTimeString().match(/\(([A-Za-z ]+)\)$/))?e[1]:"GMT"}if(!jt){jt=!0,w[Yt()>>2]=60*(new Date).getTimezoneOffset();var t=new Date(2e3,0,1),n=new Date(2e3,6,1);w[Kt()>>2]=Number(t.getTimezoneOffset()!=n.getTimezoneOffset());var r=e(t),a=e(n);r=p(Jt(r)),a=p(Jt(a)),n.getTimezoneOffset()<t.getTimezoneOffset()?(w[$t()>>2]=r,w[$t()+4>>2]=a):(w[$t()>>2]=a,w[$t()+4>>2]=r)}}(),e=new Date(1e3*w[e>>2]),w[4580]=e.getSeconds(),w[4581]=e.getMinutes(),w[4582]=e.getHours(),w[4583]=e.getDate(),w[4584]=e.getMonth(),w[4585]=e.getFullYear()-1900,w[4586]=e.getDay();var t=new Date(e.getFullYear(),0,1);w[4587]=(e.getTime()-t.getTime())/864e5|0,w[4589]=-60*e.getTimezoneOffset();var n=new Date(2e3,6,1).getTimezoneOffset();return e=0|(n!=(t=t.getTimezoneOffset())&&e.getTimezoneOffset()==Math.min(t,n)),w[4588]=e,e=w[$t()+(e?4:0)>>2],w[4590]=e,18320},O:function(e){var t=Date.now()/1e3|0;return e&&(w[e>>2]=t),t},N:function(){on("OOM")},a:R},m);t.asm=Ht,t.___embind_register_native_and_builtin_types=function(){return t.asm.ba.apply(null,arguments)};var Xt=t.___getTypeName=function(){return t.asm.ca.apply(null,arguments)},Kt=t.__get_daylight=function(){return t.asm.da.apply(null,arguments)},Yt=t.__get_timezone=function(){return t.asm.ea.apply(null,arguments)},$t=t.__get_tzname=function(){return t.asm.fa.apply(null,arguments)},Qt=t._free=function(){return t.asm.ga.apply(null,arguments)},Zt=t._malloc=function(){return t.asm.ha.apply(null,arguments)},en=t.globalCtors=function(){return t.asm.Ga.apply(null,arguments)};t.stackAlloc=function(){return t.asm.Ha.apply(null,arguments)},t.dynCall_i=function(){return t.asm.ia.apply(null,arguments)},t.dynCall_ii=function(){return t.asm.ja.apply(null,arguments)},t.dynCall_iii=function(){return t.asm.ka.apply(null,arguments)},t.dynCall_iiii=function(){return t.asm.la.apply(null,arguments)},t.dynCall_iiiii=function(){return t.asm.ma.apply(null,arguments)},t.dynCall_iiiiii=function(){return t.asm.na.apply(null,arguments)},t.dynCall_iiiiiifi=function(){return t.asm.oa.apply(null,arguments)},t.dynCall_iiiiiiiiii=function(){return t.asm.pa.apply(null,arguments)},t.dynCall_iiiji=function(){return t.asm.qa.apply(null,arguments)},t.dynCall_ji=function(){return t.asm.ra.apply(null,arguments)},t.dynCall_jiji=function(){return t.asm.sa.apply(null,arguments)},t.dynCall_v=function(){return t.asm.ta.apply(null,arguments)};var tn=t.dynCall_vi=function(){return t.asm.ua.apply(null,arguments)};t.dynCall_vii=function(){return t.asm.va.apply(null,arguments)},t.dynCall_viifiii=function(){return t.asm.wa.apply(null,arguments)};var nn=t.dynCall_viii=function(){return t.asm.xa.apply(null,arguments)};function rn(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e}function an(){function e(){if(!t.calledRun&&(t.calledRun=!0,!d)){if(D||(D=!0,M(F)),M(k),t.onRuntimeInitialized&&t.onRuntimeInitialized(),t.postRun)for("function"==typeof t.postRun&&(t.postRun=[t.postRun]);t.postRun.length;){var e=t.postRun.shift();O.unshift(e)}M(O)}}if(!(0<j)){if(t.preRun)for("function"==typeof t.preRun&&(t.preRun=[t.preRun]);t.preRun.length;)W();M(U),0<j||t.calledRun||(t.setStatus?(t.setStatus("Running..."),setTimeout(function(){setTimeout(function(){t.setStatus("")},1),e()},1)):e())}}function on(e){throw t.onAbort&&t.onAbort(e),void 0!==e?(i(e),s(e),e='"'+e+'"'):e="",d=!0,"abort("+e+"). Build with -s ASSERTIONS=1 for more info."}if(t.dynCall_viiif=function(){return t.asm.ya.apply(null,arguments)},t.dynCall_viiifi=function(){return t.asm.za.apply(null,arguments)},t.dynCall_viiifiii=function(){return t.asm.Aa.apply(null,arguments)},t.dynCall_viiii=function(){return t.asm.Ba.apply(null,arguments)},t.dynCall_viiiii=function(){return t.asm.Ca.apply(null,arguments)},t.dynCall_viiiiii=function(){return t.asm.Da.apply(null,arguments)},t.dynCall_viiiiiiiii=function(){return t.asm.Ea.apply(null,arguments)},t.dynCall_viij=function(){return t.asm.Fa.apply(null,arguments)},t.asm=Ht,t.then=function(e){if(t.calledRun)e(t);else{var n=t.onRuntimeInitialized;t.onRuntimeInitialized=function(){n&&n(),e(t)}}return t},rn.prototype=Error(),rn.prototype.constructor=rn,N=function e(){t.calledRun||an(),t.calledRun||(N=e)},t.run=an,t.abort=on,t.preInit)for("function"==typeof t.preInit&&(t.preInit=[t.preInit]);0<t.preInit.length;)t.preInit.pop()();return t.noExitRuntime=!0,an(),t.maxBytesDownloaded=0,t.minBytesDownloaded=0,t.URLsDownloaded=new Set([]),e});const o={RGBA32:0,RGB24:1,BC1:2,BC3:3,BC4:4,BC5:5,ETC1_RGB:6,RGBA_FLOAT32:7,UNC1:8,JPEG:9,PNG:10,BMP:11,PSD:12,TGA:13,GIF:14,HDR:15,PIC:16,PNM:17,ASTC_4X4:18,ASTC_5X4:19,ASTC_5X5:20,ASTC_6X5:21,ASTC_6X6:22,ASTC_8X5:23,ASTC_8X6:24,ASTC_10X5:25,ASTC_10X6:26,ASTC_8X8:27,ASTC_10X8:28,ASTC_10X10:29,ASTC_12X10:30,ASTC_12X12:31,ARGB32:32,R8:33,PVRTC1_RGB4:34,PVRTC1_RGBA4:35,UINT8:36,UINT16:37,UINT32:38,RGB565:39,RG8:40,RG16F:41,COUNT:42},i=["rgba32","rgb24","bc1","bc3","bc4","bc5","etc1_rgb","rgba_float32","unc1","jpeg","png","bmp","psd","tga","gif","hdr","pic","pnm","astc_4x4","astc_5x4","astc_5x5","astc_6x5","astc_6x6","astc_8x5","astc_8x6","astc_10x5","astc_10x6","astc_8x8","astc_10x8","astc_10x10","astc_12x10","astc_12x12","argb32","r8","pvrtc1_rgb4","pvrtc1_rgba4","uint8","uint16","uint32","rgb565","rg8","rg16f","count"],s=["linear","srgb"],u=["diffuse","normal","legacy_unused","specular","meta_index"],l={None:0,BC1:1,BC2:2,BC3:4,BC4:8,BC5:16,BC6H:32,BC7:64,ASTC:128,ETC1:256,ETC2:512,EAC_R:1024,EAC_RG:2048,PVRTC1:4096,PVRTC2:8192,ATC:16384,HalfFloat:32768,All:-1};var c=Object.freeze({TextureFormat:o,TextureFormatNames:i,ColorSpace:{LINEAR:0,SRGB:1},ColorSpaceNames:s,TextureType:{DIFFUSE:0,NORMAL:1,LEGACY_UNUSED:2,SPECULAR:3,META_INDEX:4,COUNT:5},TextureTypeNames:u,TextureCapability:l});const f=l,d=32;function h(e){if(!Number.isInteger(e))throw new Error("Value was not integer: "+e.toString())}let p=e=>{class t{constructor(t,n=Float32Array){if(h(t/n.BYTES_PER_ELEMENT),0===t)throw new Error("Buffer size was zero");if(this.ofs=e._malloc(t),0===this.ofs)throw new Error(`Allocation of ${t} bytes failed.`);this.size=t,this.type=n}destroy(){e._free(this.ofs),this.ofs=0,this.size=0}ensureSize(t){if(this.size<t){if(this.destroy(),this.ofs=e._malloc(t),0===this.ofs)throw new Error(`Buffer growth to ${t} bytes failed.`);this.size=t}}floats(){return new Float32Array(e.HEAPF32.buffer,this.ofs,this.size/4)}bytes(){return new Uint8Array(e.HEAPU8.buffer,this.ofs,this.size)}}class n{constructor(e,t=0,n=e.size,r=e.type){this.ofs=e.ofs,this.start=t,this.size=n,this.type=r,this.heapName=p.get(r)}getArray(){return new this.type(e[this.heapName].buffer,this.ofs+this.start,this.size/this.type.BYTES_PER_ELEMENT)}}const r=e.getRenderableSize(),a=e.getRenderableFields(),c=new t(24),p=new Map([[Float32Array,"HEAPF32"],[Uint32Array,"HEAPU32"],[Uint16Array,"HEAPU16"],[Uint8Array,"HEAPU8"]]);function m(e,t){for(let n=0;n<16;n++)e[n]=t[n]}class y{constructor(n){this.ptr=n,this.creds=e.sceneCredsCreate(),this.matrixBuffer=new t(64)}destroy(){e.sceneCredsDestroy(this.creds),this.matrixBuffer.destroy()}connect(t,n,r){if("string"!=typeof t)throw new TypeError("token should be a string");if("string"!=typeof n)throw new TypeError("projectID should be a string");if("string"!=typeof r)throw new TypeError("modelID should be a string");e.sceneConnect(this.ptr,this.creds,t,n,r)}connectWithURL(t){if("string"!=typeof t)throw new TypeError("URL should be a string");if(0!==t.indexOf("http:")&&0!==t.indexOf("https:"))throw new Error("Should be an HTTP or HTTPS URL");e.sceneConnectWithURL(this.ptr,this.creds,t)}connectionStatus(){return e.sceneGetConnectionStatus(this.ptr)}getInfo(t){return e.sceneGetInfo(this.ptr)}isConnected(){return this.connectionStatus()===e.ConnectionStatus.Connected}update(t){if(!Array.isArray(t))throw new TypeError("Matrix should be an array");if(16!==t.length)throw new TypeError("Matrix should be of size 4x4");m(this.matrixBuffer.floats(),t),e.sceneUpdate(this.ptr,this.matrixBuffer.ofs)}}class g{constructor(e,n){this.ptr=e,this.matrixBuffer=new t(64),this.vectorBuffer=new t(16),this.lightBuffer=new t(3*d*4),this.temp=void 0,this.runtimeAssets=n}destroy(){this.matrixBuffer.destroy(),this.vectorBuffer.destroy(),this.lightBuffer.destroy(),this.temp&&this.temp.destroy()}update(t,n,r,a=[]){if(!Array.isArray(t))throw new TypeError("Camera matrix should be an array");if(!Array.isArray(n))throw new TypeError("Position should be an array");if("number"!=typeof r)throw new TypeError("Quality should be a number");if(16!==t.length)throw new TypeError("Camera matrix should be of size 4x4");if(3!==n.length)throw new TypeError("Position vector should be of length 3");var o,i;if(m(this.matrixBuffer.floats(),t),o=this.vectorBuffer.floats(),i=n,o[0]=i[0],o[1]=i[1],o[2]=i[2],a){if(a.length>d)throw new Error("Too many lights given");const e=this.lightBuffer.floats();for(let t=0;t<a.length;t++)e[3*t+0]=a[t][0],e[3*t+1]=a[t][1],e[3*t+2]=a[t][2]}e.viewUpdate(this.ptr,this.matrixBuffer.ofs,r,this.vectorBuffer.ofs,this.lightBuffer.ofs,a.length)}getVisible(n){h(n);const o=n*r;(!this.temp||this.temp.size<o)&&(this.temp&&this.temp.destroy(),this.temp=new t(o));const i=this.temp,s=r/4,u=o/4,l=a;h(s),h(u);let c=(e,t,n,r)=>(h(r/4),new e(t.buffer,n+r,u-r/4));const f=c(Uint32Array,e.HEAPU32,i.ofs,l.mesh),d=c(Int32Array,e.HEAP32,i.ofs,l.lodLevel),p=c(Uint32Array,e.HEAPU32,i.ofs,l.visibilityMask),m=e.viewNextRenderables(this.ptr,i.ofs,n);let y=[];for(let e=0;e<m;e++){const t=f[s*e],n=d[s*e],r=p[s*e];y.push({id:t,mesh:this.runtimeAssets.get(t),lod:n,mask:r})}return y}}let v=new Map([[e.JobType.StreamIn,"Create"],[e.JobType.StreamOut,"Destroy"]]),b=new Map([[e.AssetType.Material,"Material"],[e.AssetType.Texture,"Texture"],[e.AssetType.Mesh,"Mesh"]]);class w{constructor(t){this.ptr=t,this.jobType=v.get(e.jobGetJobType(t)),this.assetType=b.get(e.jobGetAssetType(t)),this.type=this.jobType+this.assetType,this.data={}}finish(t,n){e.jobFinish(this.ptr,t,n)}success(t=0){e.jobFinish(this.ptr,e.JobResult.Success,t)}fail(){e.jobFinish(this.ptr,e.JobResult.Failure,0)}get userPointer(){return e.jobGetUserPointer(this.ptr)}}const T=new Map([["position",new t(4)],["normal",new t(4)],["uv",new t(4)],["tangent",new t(4)],["index",new t(4)]]);function A(e,n,r){let a=T.get(e);return a.size<n?(a.size>0&&a.destroy(),a=new t(n,r),T.set(e,a)):r&&(a.type=r),a}class _{constructor(e){this.ptr=e}setBuffers(t){if(!e.meshLoaderSetBuffers(this.ptr,t))throw console.log(t),new Error("setBuffers failed")}loadNext(){return e.meshLoaderLoadNext(this.ptr)}done(){return e.meshLoaderDone(this.ptr)}allocateBuffers(){const t=e.meshLoaderGetAttributes(this.ptr),r=this.uniqueVertexCount;let a=e.getEmptyMeshBufferDesc(),o={},i={};Object.keys(t).forEach(e=>{const n=r*t[e].elemSize;h(n/Float32Array.BYTES_PER_ELEMENT),i[e]=n}),Object.keys(t).forEach(e=>{let n=A(e,i[e],Float32Array),s=a[e];o[e]=n,s.ptr=n.ofs,s.elemSize=t[e].elemSize,s.size=r,s.stride=s.elemSize,s.flags=0});const s=this.indexCount,u=r<65536?2:4;if(0===s)throw new Error("Mesh index count was zero!");let l=s*u;const c=A("index",l,2===u?Uint16Array:Uint32Array);let f={};f.elemSize=u,f.ptr=c.ofs,f.size=s,f.stride=f.elemSize,f.flags=0,o.index=c,i.index=l,a.index=f;let d={};return Object.keys(o).forEach(e=>{d[e]=new n(o[e],0,i[e])}),{buffers:d,desc:a}}get uniqueVertexCount(){return e.meshLoaderUniqueVertexCount(this.ptr)}get indexCount(){return e.meshLoaderIndexCount(this.ptr)}get attributes(){return e.meshLoaderGetAttributes(this.ptr)}get material(){return e.meshLoaderGetMaterial(this.ptr)}get bounds(){e.meshLoaderGetBounds(this.ptr,c.ofs);const t=c.floats();return[[t[0],t[1],t[2]],[t[3],t[4],t[5]]]}}return{Client:class{constructor(){this.ptr=e.clientCreate()}destroy(){e.clientDestroy(this.ptr),this.ptr=0}},Runtime:class{constructor(n,r){const a=f.ETC1|f.ASTC|f.PVRTC1|f.BC5;let o=r.capabilityMask;o&a||(o|=f.BC5|f.BC4),this.client=n,this.ptr=e.runtimeCreate(n.ptr,o),this.platformFeatures=r,this.assets=new Map,this.nextId=1,this.loader=void 0,this.tempTextureBuffer=new t(1048576,Uint8Array),this.tempTranscodedBuffer=new t(4,Uint8Array),this.debug={textureFormatsInUse:new Set,platformFeatures:r}}destroy(){this.tempTextureBuffer.destroy(),this.tempTranscodedBuffer.destroy(),this.client.destory(),e.runtimeDestroy(this.ptr),this.ptr=0}createScene(){const t=e.runtimeCreateScene(this.ptr);return new y(t)}destroyScene(t){e.runtimeDestroyScene(this.ptr,t.ptr)}createView(){const t=e.runtimeCreateView(this.ptr);return new g(t,this.assets)}destroyView(t){e.runtimeDestroyView(this.ptr,t.ptr)}update(){e.runtimeUpdate(this.ptr)}*getJobs(){for(;;){if(this.loader){if(!this.loader.done()){if(!this.loader.loadNext())throw new Error("loadNext failed");yield;continue}{let e=this.loader.ownerJob;e.data.buffers=this.loader.vertexBuffers.buffers,e.data.desc=this.loader.vertexBuffers.desc,e.data.material=this.assets.get(this.loader.material),e.data.bounds=this.loader.bounds,this.loader=void 0,yield e}}let t=e.runtimeGetJob(this.ptr);if(0===t)return;let r=new w(t);if("CreateMaterial"===r.type)r.data=e.jobGetMaterialData(r.ptr),r.data.textures=r.data.textures.map(e=>this.assets.get(e)),yield r;else if("CreateTexture"===r.type){let t=e.jobGetTextureData(r.ptr),a=this.tempTextureBuffer;if(a.ensureSize(t.dataByteSize),!e.jobCopyTextureContents(r.ptr,a.ofs,a.size,!1)){r.fail();const e="Texture copying failed! Job pointer: "+r.ptr+", buffer ofs: "+a.ofs+", buffer size: "+a.size;throw new Error(e)}let l=new n(a,0,t.dataByteSize);if(this.formatNeedsTranscoding(t.format)){t=this.downsampleAndTranscodeTexture(t,a,this.tempTranscodedBuffer);const e={[o.RGBA32]:Uint8Array,[o.RGB565]:Uint16Array,[o.RG8]:Uint8Array,[o.RG16F]:Uint16Array};(l=new n(this.tempTranscodedBuffer,0,t.dataByteSize)).type=e[t.format]}t.format=i[t.format],t.colorSpace=s[t.colorSpace],t.textureType=u[t.textureType],this.debug.textureFormatsInUse.add(t.format),r.data={info:t,buffer:l},yield r}else if("CreateMesh"===r.type)this.loader=new _(e.jobGetMeshLoader(r.ptr)),this.loader.vertexBuffers=this.loader.allocateBuffers(),this.loader.setBuffers(this.loader.vertexBuffers.desc),this.loader.ownerJob=r,yield;else{if("Destroy"!==r.jobType)throw new Error("Job wasn't handled correctly");r.data=this.assets.get(r.userPointer),yield r}}}handleJobs(e,t){const n=performance.now();for(let r of this.getJobs()){if(r)try{e[r.type](r)}catch(e){throw r.fail(),e}if(performance.now()-n>t)break}}addAsset(t,n){const r=this.nextId;this.nextId=this.nextId+1|0,0===this.nextId&&(this.nextId=1),this.assets.set(r,n),t.finish(e.JobResult.Success,r)}removeAsset(t,n){const r=t.userPointer;this.assets.has(r)&&this.assets.delete(r),t.finish(e.JobResult.Success,0)}failJob(t){t.finish(e.JobResult.Failure,0)}formatNeedsTranscoding(e){const t=this.platformFeatures.capabilityMask;switch(e){case o.BC1:if(t&l.BC1)return!1;break;case o.BC3:if(t&l.BC3)return!1;break;case o.BC4:if(t&l.BC4)return!1;break;case o.BC5:if(t&l.BC5)return!1;break;default:return!1}return!0}downsampleAndTranscodeTexture(t,n,r){let a=e.getUncompressedFromBCFormat(t.format);if(a===o.COUNT)throw new Error("Couldn't find a matching BC format");a!==o.RG16F||this.platformFeatures.halfFloat||(a=o.RG8);const i=e.getTextureByteSize(t.width,t.height,a);r.ensureSize(i);const s=e.downsampleAndTranscodeTexture(t.format,a,t.width,t.height,n.ofs,t.dataByteSize,r.ofs,r.size);if(!s.success)throw new Error(`Texture transcoding failed. Input: ${t.format}, output: ${a}, output size: ${i}`);if(s.texture.format!==a)throw new Error(`Transcoded texture format was ${s.texture.format} instead of the expected ${a}`);let u=Object.assign({},t),l=s.texture;return u=Object.assign(u,{format:l.format,width:l.width,height:l.height,dataByteSize:l.dataByteSize,mipByteSizes:[l.dataByteSize]})}getDebugInfo(){return e.runtimeGetDebugInfo(this.ptr)}}}};function m(e){const t={};return t.getProjects=t=>{let n=e.parseCloudCredentials(t);if(""===n.key)throw new Error("Couldn't parse token ",t);return function(e,t,n){let r=function(e,t){let n=e.url;return"/"!==n.substr(-1)&&(n+="/"),n+="api/v2",n+=t}(e,t),a=Object.assign({method:"GET",headers:{"Umbra-Client":"UmbraJS",Authorization:"Basic "+btoa(e.key+":")},mode:"cors"},n);return fetch(r,a).then(function(e){if(!e.ok)throw new Error("HTTP error, status = "+e.status);return e.json()})}(n,"/projects",{})},t.getPlatformFeatures=e=>{let t=0,n=new Set,r=!1,a=!1,o=new Map([]),i=[],s=e.getSupportedExtensions();for(let e of s){let t=e.replace(/^(.*)_WEBGL_/,"WEBGL_");o.set(t,e),i.push(t)}const u=new Map([["WEBGL_compressed_texture_s3tc",{mask:l.BC1|l.BC2|l.BC3,names:["bc1","bc2","bc3"]}],["WEBGL_compressed_texture_s3tc_srgb",{mask:l.BC1|l.BC2|l.BC3,names:["bc1","bc2","bc3"]}],["WEBGL_compressed_texture_rgtc",{mask:l.BC4|l.BC5,names:["bc4","bc5"]}],["WEBGL_compressed_texture_pvrtc",{mask:l.PVRTC1,names:["pvrtc1_rgb4","pvrtc1_rgba4"]}],["WEBGL_compressed_texture_etc1",{mask:l.ETC1,names:["etc1_rgb"]}],["WEBGL_compressed_texture_astc",{mask:l.ASTC,names:["astc_4x4"]}]]);for(let r of u.keys())if(i.includes(r)){e.getExtension(o.get(r));let a=u.get(r);t|=a.mask,a.names.forEach(e=>n.add(e))}return i.includes("WEBGL_compressed_texture_s3tc_srgb")&&(r=!0),i.includes("EXT_sRGB")&&(e.getExtension(o.get("EXT_sRGB")),r=!0),i.includes("OES_texture_half_float")&&(e.getExtension(o.get("OES_texture_half_float")),a=!0),{capabilityMask:t,formats:[...n],srgb:r,halfFloat:a}},t.getIDs=({token:e,projectID:n,modelID:r,model:a,project:o})=>{if(n&&r)return Promise.resolve({project:n,model:r});if(o&&a)return t.getProjects(e).then(e=>{const t=e.find(e=>e.name===o),n=t.models.find(e=>e.name===n);if(!t){const t=e.map(e=>e.name);throw new Error("Couldn't find a project with name \""+o+'". Only found the following: '+t)}if(!n){const e=t.models.map(e=>e.name);throw new Error("Couldn't find a model with name \""+n+'". Only found the following: '+e)}return{project:t.id,model:n.id}});throw new Error('Invalid project & model ID combination.\nYou should define either both "projectID" and "modelID" or "project" and "model"')},t.nativeModule=e,t.wrappers=p(e),t}let y=function(e){return e=Object.assign({wasmURL:""},e),new Promise((t,n)=>{try{a({locateFile:(t,n)=>t.endsWith("umbra.wasm")&&""!==e.wasmURL?e.wasmURL:n+t}).then(e=>{delete e.then,e.onAbort=e=>{n(e)},t(m(e))})}catch(e){n(e)}})};function g(e,t,n){return{format:e,type:t,compressed:n}}const v={rgb24:g(n.RGBFormat,n.UnsignedByteType,!1),rgba32:g(n.RGBAFormat,n.UnsignedByteType,!1),rgb565:g(n.RGBFormat,n.UnsignedShort565Type,!1),rg8:g(n.LuminanceAlphaFormat,n.UnsignedByteType,!1),rg16f:g(n.LuminanceAlphaFormat,n.HalfFloatType,!1),bc1:g(n.RGBA_S3TC_DXT1_Format,n.UnsignedByteType,!0),bc3:g(n.RGBA_S3TC_DXT5_Format,n.UnsignedByteType,!0),etc1_rgb:g(n.RGB_ETC1_Format,n.UnsignedByteType,!0),astc_4x4:g(n.RGBA_ASTC_4x4_Format,n.UnsignedByteType,!0),pvrtc1_rgb4:g(n.RGB_PVRTC_4BPPV1_Format,n.UnsignedByteType,!0)},b="\n#ifdef USE_NORMALMAP\n#ifdef USE_TANGENT\n\nvec3 tangentToWorld2 = normal;\nvec3 tangentToWorld0 = normalize(tangent - tangentToWorld2 * dot(tangentToWorld2, tangent));\n\n#ifdef UMBRA_FLIP_TANGENT\nvec3 tangentToWorld1 = normalize(cross(tangentToWorld0, tangentToWorld2));\n#else\nvec3 tangentToWorld1 = normalize(cross(tangentToWorld2, tangentToWorld0));\n#endif\n\n#if defined(UMBRA_TEXTURE_SUPPORT_BC5) || defined(UMBRA_TEXTURE_SUPPORT_ASTC)\nnormal.xy = texture2D(normalMap, vUv).xy * 2.0 - 1.0;\nnormal.z = sqrt(1.0 - clamp(dot(normal.xy, normal.xy), 0.0, 1.0));\n#elif defined(UMBRA_TEXTURE_SUPPORT_BC3)\nnormal.xy = texture2D(normalMap, vUv).yw * 2.0 - 1.0;\nnormal.z = sqrt(1.0 - clamp(dot(normal.xy, normal.xy), 0.0, 1.0));\n#else\nnormal.xyz = texture2D(normalMap, vUv).xyz;\nnormal.xy *= 2.0;\nnormal.xy -= 1.0;\nnormal = normalize(normal);\n#endif\n\nnormal = tangentToWorld0 * normal.x + tangentToWorld1 * normal.y + tangentToWorld2 * normal.z;\nnormal = normalize(normal);\n#endif\n#endif\n\n",w="\nfloat metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\nvec4 texelMetalness = texture2D( metalnessMap, vUv );\nmetalnessFactor *= texelMetalness.r;\n#endif\n",T="\nfloat roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\nvec4 texelRoughness = texture2D( roughnessMap, vUv );\nfloat roughness = 1.0 - texelRoughness.g;\nroughnessFactor *= roughness;\n#endif\n";class A{constructor(e){this.flipTangent=!1,this.defines="",e.formats.indexOf("bc3")>-1&&(this.defines+="#define UMBRA_TEXTURE_SUPPORT_BC3\n"),e.formats.indexOf("bc5")>-1&&(this.defines+="#define UMBRA_TEXTURE_SUPPORT_BC5\n"),e.formats.indexOf("astc_4x4")>-1&&(this.defines+="#define UMBRA_TEXTURE_SUPPORT_ASTC\n")}process(e,t){let n=e.fragmentShader;this.flipTangent&&(n="#define UMBRA_FLIP_TANGENT\n"+n),n=(n=(n=(n=this.defines+n).replace("#include <normal_fragment_maps>",b)).replace("#include <metalnessmap_fragment>",w)).replace("#include <roughnessmap_fragment>",T),e.fragmentShader=n}}class _{constructor(){this.usedList=[],this.freeList=[]}allocate(e){let t;return t=this.freeList.length>0?this.freeList.pop():e(),this.usedList.push(t),t}freeAll(e){for(let t=0;t<this.usedList.length;t++)e&&e(this.usedList[t]),this.freeList.push(this.usedList[t]);this.usedList.length=0}clear(){this.usedList.length=0,this.freeList.length=0}}function C(e,t,r,a){n.Object3D.call(this),this.quality=.5,this.opaqueMaterial=new n.MeshBasicMaterial,this.wireframe=!1,this.freeze=!1,this.scale.set(1,1,-1),this.stats={numVisible:0,numShadowCasters:0,numCachedMaterials:0,numAssets:0},this.isLOD=!0,this.autoUpdate=!0,this.renderer=r,this.cameraToView=new Map,this.viewLastUsed=new Map,this.materialPool=new _,this.shaderPatcher=new A(a.features),this.name="UmbraModel",this.umbra={runtime:e,scene:t},this.matrixWorldInverse=new n.Matrix4,this.projScreenMatrix=new n.Matrix4,this.cameraWorldPosition=new n.Vector3,this.tempVector=new n.Vector3,this.dirVector=new n.Vector3}function x(e,t){this.geometry=e,this.materialDesc=t}C.prototype=Object.create(n.Object3D.prototype),C.prototype.constructor=n.Object3D,C.prototype.getInfo=function(){let e={connected:this.umbra.scene.isConnected()};return e.connected&&(e.sceneInfo=this.umbra.scene.getInfo()),Object.assign(e,this.stats),e},C.prototype.getBounds=function(){if(!this.umbra.scene.isConnected())return;const e=this.umbra.scene.getInfo().bounds,t=e.min,r=e.max;return new n.Box3(new n.Vector3(t[0],t[1],t[2]),new n.Vector3(r[0],r[1],r[2]))},C.prototype.getCenter=function(){const e=this.getBounds();e.applyMatrix4(this.matrixWorld);let t=new n.Vector3;return e.getCenter(t),t},C.prototype.pruneOldViews=function(e){for(let[t,n]of this.viewLastUsed)if(e-n>1e3){for(let[e,n]of this.cameraToView)if(n===t){this.cameraToView.delete(e);break}this.umbra.runtime.destroyView(t),this.viewLastUsed.delete(t)}},C.prototype.update=function(e){let t;if(this.freeze)return;if(this.traverseAncestors(e=>{e.isScene&&(t=e)}),!t&&!t.isScene)return void console.log("No parent scene found");let r=[];this.renderer.shadowMap.enabled&&(r=function(e){const t=[];return e.traverseVisible(e=>{e.isDirectionalLight&&e.castShadow&&t.push(e)}),t}(t));let a=this.cameraToView.get(e);a||(a=this.umbra.runtime.createView(),this.cameraToView.set(e,a));const o=this.renderer.info.render.frame;if(this.viewLastUsed.set(a,o),this.pruneOldViews(o),this.umbra.scene.update(this.matrixWorld.elements),void 0!==this.opaqueMaterial.normalMapType){const e=this.matrixWorld.determinant()<0;e!==this.shaderPatcher.flipTangent&&(this.shaderPatcher.flipTangent=e,this.materialPool.clear())}this.matrixWorldInverse.getInverse(e.matrixWorld),this.projScreenMatrix.multiplyMatrices(e.projectionMatrix,this.matrixWorldInverse);let i=this.dirVector,s=this.tempVector;const u=r.map(e=>(i.setFromMatrixPosition(e.target.matrixWorld),s.setFromMatrixPosition(e.matrixWorld),i.sub(s),[i.x,i.y,i.z]),r);e.umbraStreamingPosition?this.cameraWorldPosition.copy(e.umbraStreamingPosition):e.getWorldPosition(this.cameraWorldPosition);const l=this.cameraWorldPosition;a.update(this.projScreenMatrix.elements,[l.x,l.y,l.z],this.quality,u),this.stats.numVisible=0,this.stats.numAssets=this.umbra.runtime.assets.size;let f=[];for(let e=0;e<this.children.length;e++)this.children[e].isUmbraMesh||f.push(this.children[e]);this.children=f;let d=[],h=new n.Object3D;h.isLOD=!0,h.autoUpdate=!0,h.update=e=>{this.children.pop();for(let e=0;e<d.length;e++)this.children.push(d[e])},this.materialPool.freeAll(e=>{delete e.map,delete e.normalMap,delete e.metalnessMap,delete e.roughnessMap});let p=[];do{p=a.getVisible(200);for(let e=0;e<p.length;e++){const{materialDesc:t,geometry:r}=p[e].mesh,a=this.materialPool.allocate(()=>this.opaqueMaterial.clone());a.wireframe=this.wireframe,a.onBeforeCompile=(e,t)=>{this.opaqueMaterial.onBeforeCompile&&this.opaqueMaterial.onBeforeCompile.apply(a,[e,t]),this.shaderPatcher.process(e,t)};const o=t.textures[c.TextureType.DIFFUSE],i=t.textures[c.TextureType.NORMAL],s=t.textures[c.TextureType.SPECULAR];o&&o.isTexture&&(a.map=o),i&&i.isTexture&&(a.normalMap=i,a.vertexTangents=!0,a.normalMapType=n.TangentSpaceNormalMap),s&&s.isTexture&&(a.metalnessMap=s,a.metalness=1,a.roughnessMap=s,a.roughness=1);const u=new n.Mesh(r,a);u.isUmbraMesh=!0,u.matrixWorld.copy(this.matrixWorld),u.castShadow=this.castShadow,u.receiveShadow=this.receiveShadow,u.visible=!0,this.children.push(u),0==(1&p[e].mask)?(d.push(u),u.frustumCulled=!0):(this.children.push(u),u.frustumCulled=!1)}this.stats.numVisible+=p.length}while(200===p.length);this.stats.numShadowCasters=d.length,this.stats.numCachedMaterials=this.materialPool.usedList.length+this.materialPool.freeList.length,d.length>0&&this.children.push(h)},C.prototype.dispose=function(){this.umbra.runtime.destroyView(this.umbra.view),this.umbra.runtime.destroyScene(this.umbra.scene)},t.initWithThreeJS=function(e,t){if("106"!==n.REVISION)throw new Error(`Only three.js r106 is supported. Got three.js ${n.REVISION} instead.`);if(!e)throw new TypeError('"renderer" should be of type THREE.WebGLRenderer');return y(t).then(t=>{const r=t.getPlatformFeatures(e.context);r.capabilityMask&=~c.TextureCapability.BC5;let a=new t.wrappers.Runtime(new t.wrappers.Client,r);return{createModel:n=>{const o=a.createScene();return new Promise((i,s)=>{try{if(!("url"in n))return t.getIDs(n).then(t=>{o.connect(n.token,t.project,t.model),i(new C(a,o,e,{features:r}))},()=>{throw console.log("error"),new Error(`Couldn't fetch IDs matching names ${n.project} and ${n.model}`)});o.connectWithURL(n.url),i(new C(a,o,e,{features:r}))}catch(e){a.destroyScene(o),s(e)}})},getStats:function(){return{maxBytesDownloaded:t.nativeModule.maxBytesDownloaded,minBytesDownloaded:t.nativeModule.minBytesDownloaded}},update:function(t=10){const r={CreateMaterial:e=>{a.addAsset(e,e.data)},DestroyMaterial:e=>{a.removeAsset(e,e.data)},CreateTexture:t=>{const r=t.data.info,o=t.data.buffer;let i;if(v.hasOwnProperty(r.format)&&(i=v[r.format]),!i)return console.log("Unknown texture format",r.format),void a.addAsset(t,{isTexture:!1});const s=new o.type(o.getArray().slice());let u;if(i.compressed){const e={width:r.width,height:r.height,data:s};u=new n.CompressedTexture([e],r.width,r.height)}else u=new n.DataTexture(s,r.width,r.height);u.format=i.format,u.type=i.type,u.magFilter=n.LinearFilter,u.minFilter=n.LinearFilter,u.anisotropy=0,"diffuse"!==r.textureType||e.gammaOutput?u.encoding="linear"===r.colorSpace?n.LinearEncoding:n.sRGBEncoding:u.encoding=n.LinearEncoding,u.needsUpdate=!0,a.addAsset(t,u)},DestroyTexture:e=>{e.data.isTexture&&e.data.dispose(),a.removeAsset(e,e.data)},CreateMesh:e=>{const t=new n.BufferGeometry,r=e.data.buffers.index.getArray(),o=Array.from(r);t.setIndex(o),t.boundingSphere=function(e){const t=e[0],r=e[1],a=new n.Vector3(r[0]-t[0],r[1]-t[1],r[2]-t[2]),o=new n.Vector3(t[0]+.5*a.x,t[1]+.5*a.y,t[2]+.5*a.z);return new n.Sphere(o,a.length())}(e.data.bounds);const i={position:{components:3},normal:{components:3},uv:{components:2},tangent:{components:3}};Object.keys(i).forEach(r=>{const a=e.data.buffers[r];if(a){const e=a.getArray(),o=new n.Float32BufferAttribute(e.slice(),i[r].components);t.addAttribute(r,o)}});const s=new x(t,e.data.material);a.addAsset(e,s)},DestroyMesh:e=>{const t=e.data;a.removeAsset(e,t),t.geometry.dispose()}};a.handleJobs(r,t),a.update()},dispose:()=>{a.destroy(),a=void 0},lib:t,runtime:a}})},Object.defineProperty(t,"__esModule",{value:!0})});
